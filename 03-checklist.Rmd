# Checklist {#sp-list}



```{r loadPack, echo=FALSE, message=FALSE, warning=FALSE}

library(dplyr)
library(sf)
library(mapview)
library(raster)
library(shiny)
library(ggplot2)
library(leaflet)
library(knitr)
library(grid)
library(gridSVG)
opts_knit$set(eval.after = "fig.cap")
source("function_map_leaflet.R")
source("function_map_ggplot.R")
source("function_generate_fixex_maps.R")
source("function_climate_occ_maps.R")
source("function_map_pheno.R")
load("base_plot_ST")
load("base_plot_P")
load("base_plot_ST_full")
load("base_plot_P_full")


```


```{r loadData, echo=FALSE, message=FALSE, warning=FALSE}

ST <- st_read("ST_cast.shp", quiet = TRUE)
P <- st_read("P_cast.shp", quiet = TRUE)
protected_areas <- st_read("obo_np_stp.shp", quiet = TRUE)

combined_dataset <- 
  readxl::read_excel("combined_dataset_2021-11-22.xlsx", guess_max = 40000)

combined_dataset <- 
  combined_dataset %>% 
  filter(is.na(garden))

endemic_list <-
  combined_dataset %>%
  filter(EndemicTS == "E") %>%
  dplyr::select(
    idtax_f,
    tax_infra_level,
    tax_infra_level_auth,
    tax_fam,
    tax_gen,
    tax_famclass,
    starts_with("traitvalue"),
    taxo_unclear,
    status_revision_needed,
    Island,
    iucn_status
  ) %>%
  distinct() %>%
  arrange(tax_fam, tax_infra_level) %>% 
  filter(Island != "A")

# endemic_list_tree <- 
#   endemic_list %>% 
#   filter(grepl("tree", traitvalue_char_growth_form_level_1_1_3),
#          is.na(taxo_unclear)) %>% 
#   arrange(tax_fam, tax_infra_level)


layers_env <-
  stack("D:/MonDossierR/sao_tome_principe/all_layers_STP.tif")
names(layers_env) <-
  c("elevation_STP",
    "rainfall_STP",
    "cloud_cover_STP",
    "cloud_intra_sd__STP")

layers_env_ST <- crop(layers_env, ST)
layers_env_P <- crop(layers_env, P)

```


```{r generate-map-all, echo=FALSE, message=FALSE, warning=F, eval=FALSE}

for (i in 132:nrow(endemic_list)) {
  
  which(endemic_list$tax_infra_level == "Asplenium eurysorum")
  
  taxa_name <- endemic_list %>% slice(i) %>% pull(tax_infra_level)
  
  id_sp <- endemic_list %>%
    filter(tax_infra_level == taxa_name) %>%
    pull(idtax_f)
  
  iucn_status <- endemic_list %>%
    filter(tax_infra_level == taxa_name) %>%
    pull(iucn_status)
  
  combined_dataset_sf <-
    combined_dataset %>%
    filter(idtax_f == id_sp) %>%
    filter(georef_final == 1) %>%
    st_as_sf(coords = c("ddlon", "ddlat"))
  
  combined_dataset_transect_sf <-
    combined_dataset %>%
    filter(idtax_individual_f == id_sp) %>%
    st_as_sf(coords = c("ddlon", "ddlat"))
  
  combined_dataset_sf <- 
    bind_rows(combined_dataset_sf,
              combined_dataset_transect_sf)
  
  st_crs(combined_dataset_sf) <- 4326
  
  combined_dataset_sf <- 
    combined_dataset_sf %>% 
    mutate(accuracy_final =  ifelse(!is.na(accuracy), accuracy, calc_accuracy))
  
  combined_dataset_sf <- 
    combined_dataset_sf %>% 
    filter(accuracy_final >= 4 | is.na(accuracy_final))
  
  print(taxa_name)
  
  if (nrow(combined_dataset_sf) > 0) {
    
    fixed_maps_outputs <- 
    generate_fixed_maps(
    id_sp = id_sp,
    dataset = combined_dataset,
    dataset_sf = combined_dataset_sf,
    STP_list = list(P = P, ST = ST),
    size.legend.txt = 7,
    size.pts = 2,
    protected_areas = protected_areas, 
    device = "tiff"
  )
    
  }
  
  
}


```


```{r generate-climate-all, echo=FALSE, message=FALSE, warning=F, eval=FALSE}

for (i in 1:nrow(endemic_list)) {
  
  taxa_name <- endemic_list %>% slice(i) %>% pull(tax_infra_level)
  
  print(taxa_name)
  
  id_sp <- endemic_list %>%
    filter(tax_infra_level == taxa_name) %>%
    pull(idtax_f)
  
  combined_dataset_sf <-
    combined_dataset %>%
    filter(idtax_f == id_sp) %>%
    filter(georef_final == 1) %>%
    st_as_sf(coords = c("ddlon", "ddlat"))
  
  combined_dataset_transect_sf <-
    combined_dataset %>%
    filter(idtax_individual_f == id_sp) %>%
    st_as_sf(coords = c("ddlon", "ddlat"))
  
  combined_dataset_sf <- 
    bind_rows(combined_dataset_sf,
              combined_dataset_transect_sf)
  
  st_crs(combined_dataset_sf) <- 4326
  
  combined_dataset_sf <- 
    combined_dataset_sf %>% 
    mutate(accuracy_final =  ifelse(!is.na(accuracy), accuracy, calc_accuracy))
  
  combined_dataset_sf <- 
    combined_dataset_sf %>% 
    filter(accuracy_final >= 4 | is.na(accuracy_final))
  
  if (nrow(combined_dataset_sf) > 0) {
    
    range_ddlat <- range(st_coordinates(combined_dataset_sf)[,2])
    
    if (range_ddlat[1] < 1) {
      
      mm <- climate_occ_maps_ST(
        layers_env_ST = layers_env_ST,
        taxa = taxa_name,
        dataset = combined_dataset_sf,
        export_tiff = TRUE, 
        device = "eps", 
        shape.pts = 8
      )
      
    }
    
    if (range_ddlat[2] > 1) {
      
      mm <- climate_occ_maps_P(
        layers_env_P = layers_env_P,
        taxa = taxa_name,
        dataset = combined_dataset_sf,
        export_tiff = TRUE, 
        device = "eps"
      )
    }
  }
}


```


```{r generate-all-pheno, echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}

for (i in 1:nrow(endemic_list)) {
  
  taxa_name <- endemic_list %>% slice(i) %>% pull(tax_infra_level)
  
  print(taxa_name)
  
  id_sp <- endemic_list %>%
    filter(tax_infra_level == taxa_name) %>%
    pull(idtax_f)
  
  dataset <-
    combined_dataset %>%
    filter(idtax_f == id_sp)
  
  generate_pheno_fig(dataset = dataset, 
                     export_tiff = T, 
                     taxa_name = taxa_name)
  
}


```


```{r copy-all-fotos, eval=FALSE, echo=FALSE, message=FALSE}

for (i in 47:nrow(endemic_list)) {
  
  which(grepl("Lobelia", endemic_list$tax_infra_level))
  
  taxa_name <- endemic_list %>% slice(i) %>% pull(tax_infra_level)
  
  figs_paths <- get_figs_paths(taxa = taxa_name)

  if (any(grepl(".jpg", figs_paths$list_figs$value)) |
      (any(grepl(".JPG", figs_paths$list_figs$value)))
  ) {
    
    list_fotos <-
      figs_paths$list_figs %>%
      filter(grepl(".jpg", value) | grepl(".JPG", value)) %>%
      pull(value)
    
    copy_name_foto <-
      unlist(lapply(stringr::str_split(list_fotos, "_"), function(x)
        x[[1]]))
    copy_name_foto <-
      unlist(lapply(stringr::str_split(copy_name_foto, " "), function(x)
        x[[2]]))
    
    for (i in 1:length(list_fotos))
      file.copy(
        paste0(figs_paths$path_good_foto$path, "/", list_fotos[i]),
        paste0(
          "./images/",
          gsub(" ", "_", taxa_name),
          "_",
          i,
          "_",
          copy_name_foto[i],
          ".jpg"
        ),
        #
        overwrite = T,
        recursive = FALSE,
        copy.mode = TRUE,
        copy.date = FALSE
      )
    
    
    
    # list_fotos <-
    #   list.files("./images/", pattern = gsub(" ", "_", taxa_name))

    # paste0(figs_paths$path_good_foto, list_fotos[1])
    
  }
  
}



```



```{r, echo=FALSE, message=FALSE}

base_plot_ST <- base_plot_ST_full
base_plot_P <- base_plot_P_full

```


## Pteridophytes

```{r, echo=FALSE, message=FALSE}

list_fam <-
  endemic_list %>% 
  filter(tax_famclass %in% c("Lycopsida", "Pteropsida")) %>% 
  distinct(tax_fam) %>% arrange(tax_fam)

```


### ```r list_fam %>% slice(1)```


```{r, echo=FALSE, message=FALSE}

list_tax <-
  endemic_list %>% filter(tax_fam == list_fam %>% slice(1) %>% pull()) %>%
  distinct(tax_infra_level, tax_infra_level_auth) %>% arrange(tax_infra_level)

```

#### ```r list_tax %>% slice(1) %>% pull(tax_infra_level_auth)```


```{r , echo=FALSE, message=FALSE, warning=FALSE}

taxa_name <- list_tax %>% slice(1) %>% pull(tax_infra_level)

id_sp <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(idtax_f)

iucn_status <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(iucn_status)

combined_dataset_sf <- 
  combined_dataset %>%
  filter(georef_final == 1, 
         idtax_f == id_sp) %>%
  st_as_sf(coords = c("ddlon", "ddlat"))

st_crs(combined_dataset_sf) <- 4326


transect_data <- combined_dataset %>% filter(!is.na(id_n), tax_infra_level == taxa_name) %>% dplyr::select(stem_diameter) 

if (nrow(transect_data) >= 20) {
  
  eval_diameter_plot <- TRUE
  
} else {
  
  eval_diameter_plot <- FALSE
  
}


```


```{r , echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}

fixed_maps_outputs <- generate_fixed_maps(id_sp = id_sp,
                    dataset = combined_dataset, 
                    dataset_sf = combined_dataset_sf,
                    STP_list = list(P = P, ST = ST), 
                    size.legend.txt = 7, 
                    size.pts = 5, 
                    protected_areas = protected_areas, 
                    export_tiff = FALSE)

if (nrow(combined_dataset_sf) > 0) {
  make_lf_map <- TRUE
} else {
  make_lf_map <- FALSE
}

```


```{r, message=FALSE, echo=FALSE, warning=FALSE, eval=make_lf_map}

selected_sf <- generate_sp_leaflet(taxa = taxa_name, 
                                   dataset = combined_dataset_sf)

```

#### Status {.unnumbered}

```{r, echo=FALSE, out.width="20%"}

if (!is.na(iucn_status))
  knitr::include_graphics(paste0("./images/", iucn_status, ".png"))

```

#### Rationale {.unnumbered}

*Asplenium eurysorum* is an epiphyte fern. The species is known from Gabon and the islands of São Tomé and Príncipe. It occurs frequently within dense, tall, very wet forests with submontane affinity on rock faces in *terra firme* forest on ridge, between 160 and 1,987 m in elevation. It was previously assessed as VU D2 by Figueiredo and Gascoigne (2001), as the population was present in two locations, São Tomé and Príncipe (D2). This assessment was never published on the Red List and the fact it has been conducted 20 years ago as well as the availability of distribution data justify its reassessment.
*Asplenium eurysorum* is known from 31 collections made between 1853 (Welwitsch 14, Watt 14) and 2018 (Bidault 3983). One collection (Barter 1896) does not have precise coordinates and was not taken into account for estimating the assessment parameters. The 30 remaining collections represent 19 occurrences. In São Tomé, there are fifteen occurrences, eight of which are located within the PNOST, one outside PNOST to the southeast, and the six others to the northeast outside PNOST. However, the occurrence of São Pedro-Lagoa Amélia (Monod 11714) is considered extirpated and therefore was not taken into account for this assessment. In Príncipe, there are three occurrences, two inside the PNOP and one outside. The occurrence in Gabon is located within the Ramsar site of Birougou. The 18 remaining occurrences represent 3 subpopulations (the seeds of the species are mainly dispersed by wind). Based on a 2 x 2 km cell size, the AOO is estimated as 64 km², below the upper threshold of the EN status under subcriterion B2. The EOO is calculated as 65,392 km², above the upper threshold of the “Vulnerable” status under subcriterion B1. The two occurrences south of PNOST (Oliveira 424, Espirito Santo 5139) are threatened by old cocoa plantations and represent one location. The occurrence that is southeast of São Tomé (Oliveira 1419) is threatened by small-scale agriculture and represents one location. The two occurrences between Zampalma and Calvario (Oliveira 1461, Espirito Santo 5070) are threatened by small-scale agriculture and illegal logging and represent one location. The occurrence of Macambrara (Exell 132) is threatened by vegetable agriculture and represents one location. We infer a future disappearance of this occurrence. All occurrences that are in the touristic path in the PNOST (Gascoigne 10, Oliveira 1212, Paiva 883, Sousa 1267, Stévart 1267, Moller 28, Lejoly 1, Matos 7382) are threatened by ecotourism and invasive plants and represent one location. The occurrence in the north on the periphery of the PNOST (Paiva 467) is threatened by small-scale agriculture and illegal logging and represents one location. The occurrence between São Joaquim and São Carlos de Fundão (Gascoigne 35) in the PNOP is not threatened and represents one location. The occurrences at Pico Papagaio (Watt 24, Welwitsch 14, Paiva 595) are indirectly threatened by ecotourism and represent one location. The third occurrence of Príncipe at Ôquê Nazaré (Newton 27) is threatened by old cocoa plantations and quarries and represents one location. The occurrence of Gabon (Bidault 3983) is not threatened and represents one location. Therefore, these 18 occurrences represent 10 locations (sensu IUCN, 2019), with regards to the most important threat (small-scale agriculture). We infer a continuing decline in the extent and quality of its habitat. We also infer a continuing decline in its AOO, the number of mature individuals, and the number of subpopulations based on inferred future disappearance of one occurrence situated at Macambrara. Therefore, *Asplenium eurysorum* is assessed as VU B2ab(ii,iii,iv,v).


#### Habitat and ecology {.unnumbered}

The species occurs frequently in dense, tall, very wet lowland and submontane forests, on rocky habitat, in *terra firme* forest, on ridges, between 160 and 1,987 m in elevation.

#### Use and trade {.unnumbered}
There are no known uses of this species.

#### Population {.unnumbered}
The species has been collected more in São Tomé than in Príncipe and Gabon where it is under-collected. Its current distribution represents 3 subpopulations.


```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in São Tomé.")}

fixed_maps_outputs$map_ST

```

```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in Príncipe.")}

fixed_maps_outputs$map_P

```

```{r, eval=make_lf_map, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="An interactive distribution map."}

knitr::include_url(paste0("https://cepf-stp-threat-flora.netlify.app/img/leaflet_", 
                          gsub(" ", "_", taxa_name), ".html"))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

if (fixed_maps_outputs$map_for_ST) {
  
  base_plot_ST_spec <-
    climate_occ_maps_ST(layers_env_ST = layers_env_ST,
                        taxa = taxa_name,
                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)
  
}


if (fixed_maps_outputs$map_for_P) {
    
 base_plot_P_spec <- climate_occ_maps_P(layers_env_P = layers_env_P, 
                                        taxa = taxa_name, 
                                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)

}


```



```{r, eval=fixed_maps_outputs$map_for_ST, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of São Tomé.")}

base_plot_ST_spec

```

```{r, eval=fixed_maps_outputs$map_for_P, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of Príncipe.")}

base_plot_P_spec

```

```{r, eval=eval_diameter_plot, echo=FALSE, fig.cap=paste("Histogram of diameters of all stems identified as", taxa_name)}

combined_dataset %>% 
  filter(!is.na(id_n), tax_infra_level == taxa_name) %>% 
  dplyr::select(stem_diameter) %>% 
  ggplot() + 
  geom_histogram(mapping = aes(stem_diameter), binwidth = 1)


```


```{r, message=FALSE, echo=FALSE, warning=FALSE, results='hide'}

# figs_paths <- get_figs_paths(taxa = taxa_name)

all_files_fotos <- list.files("./images/", pattern = ".jpg")

all_files_fotos <- all_files_fotos[grepl(gsub(" ", "_", taxa_name), all_files_fotos)]

if (length(all_files_fotos) > 0) {
  
  show_foto <- TRUE
  
  copyrights <- unlist(lapply(strsplit(all_files_fotos, "_"), function(x) x[length(x)]))
  copyrights <- unlist(lapply(strsplit(copyrights, "[.]"), function(x) x[1]))
  
  caps <- paste("Copyright", copyrights)
  
} else {
  
  show_foto <- FALSE
  
}

```

```{r , eval=show_foto, echo=FALSE, fig.cap=caps, out.width = '70%'}
knitr::include_graphics(paste0("./images/", "/", all_files_fotos))
```





#### ```r list_tax %>% slice(2) %>% pull(tax_infra_level_auth)```


```{r , echo=FALSE, message=FALSE, warning=FALSE}

taxa_name <- list_tax %>% slice(2) %>% pull(tax_infra_level)

id_sp <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(idtax_f)

iucn_status <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(iucn_status)

combined_dataset_sf <- 
  combined_dataset %>%
  filter(georef_final == 1, 
         idtax_f == id_sp) %>%
  st_as_sf(coords = c("ddlon", "ddlat"))

st_crs(combined_dataset_sf) <- 4326


transect_data <- combined_dataset %>% filter(!is.na(id_n), tax_infra_level == taxa_name) %>% dplyr::select(stem_diameter) 

if (nrow(transect_data) >= 20) {
  
  eval_diameter_plot <- TRUE
  
} else {
  
  eval_diameter_plot <- FALSE
  
}


```


```{r , echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}

fixed_maps_outputs <- generate_fixed_maps(id_sp = id_sp,
                    dataset = combined_dataset, 
                    dataset_sf = combined_dataset_sf,
                    STP_list = list(P = P, ST = ST), 
                    size.legend.txt = 7, 
                    size.pts = 5, 
                    protected_areas = protected_areas, 
                    export_tiff = FALSE)

if (nrow(combined_dataset_sf) > 0) {
  make_lf_map <- TRUE
} else {
  make_lf_map <- FALSE
}

```


```{r, message=FALSE, echo=FALSE, warning=FALSE, eval=make_lf_map}

selected_sf <- generate_sp_leaflet(taxa = taxa_name, 
                                   dataset = combined_dataset_sf)

```

#### Status {.unnumbered}

```{r, echo=FALSE, out.width="20%"}

if (!is.na(iucn_status))
  knitr::include_graphics(paste0("./images/", iucn_status, ".png"))

```

#### Rationale {.unnumbered}

*Asplenium exhaustum* is an epiphytic fern, most often found in old plantations as well as in secondary forests, between 110 and 1,120 m in elevation. It is an endemic species of São Tomé. A preliminary evaluation was already made by Figueiredo and Gascoigne in 2001, who evaluated it as EN. The species is known from 13 collections made between 1905 (Chevalier 14587) and 2008 (Oliveira 1348, 1432). Five of these collections do not have precise coordinates and were not taken into account for estimating the assessment parameters. The seven remaining collections represent 6 occurrences and 1 subpopulation (the seeds of the species are mainly dispersed by wind). Based on a 2 x 2 km cell size, the AOO is estimated as 24 km², below the upper threshold of the EN status under subcriterion B2. The EOO is calculated as 146.357 km², below the upper threshold of the EN status under subcriterion B1. The occurrence (Oliveira 1348) in the south of the PNOST is not threatened and represents one location. The occurrence that is located between Valcarmo and Roça S. João (Oliveira 1432) is threatened by small-scale agriculture and oil palm plantations and represents one location. We infer a future disappearance of this occurrence due to the oil palm plantation project in this locality. The Roça Cruzeiro occurrence (Thorold 2072 and Strickland 2072) is threatened by small-scale agriculture and illegal logging and represents one location. The area around the Ecofac Center (Oliveira 98) and the area between Bom sucesso and Bombaim are threatened by small-scale agriculture and illegal logging and represent one location. The pico occurrence (Chevalier 14587) is threatened indirectly by invasive plants and represents one location. Therefore, the 6 occurrences represent 5 locations (sensu IUCN, 2019). We infer a continuing decline in EOO, AOO, habitat extent, and quality, number of locations, and number of mature individuals. The species is therefore assessed as EN B1ab(i,ii,iii,iv,v)+2ab(i,ii,iii,iv,v).



#### Habitat and ecology {.unnumbered}

The species is most often found in old plantations, as well as in secondary forests, between 110 and 1,120 m in elevation.

#### Use and trade {.unnumbered}
There are no known uses of this species.

#### Population {.unnumbered}
Population information is not precisely known for this species.


```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in São Tomé.")}

fixed_maps_outputs$map_ST

```

```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in Príncipe.")}

fixed_maps_outputs$map_P

```

```{r, eval=make_lf_map, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="An interactive distribution map."}

knitr::include_url(paste0("https://cepf-stp-threat-flora.netlify.app/img/leaflet_", 
                          gsub(" ", "_", taxa_name), ".html"))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

if (fixed_maps_outputs$map_for_ST) {
  
  base_plot_ST_spec <-
    climate_occ_maps_ST(layers_env_ST = layers_env_ST,
                        taxa = taxa_name,
                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)
  
}


if (fixed_maps_outputs$map_for_P) {
    
 base_plot_P_spec <- climate_occ_maps_P(layers_env_P = layers_env_P, 
                                        taxa = taxa_name, 
                                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)

}


```



```{r, eval=fixed_maps_outputs$map_for_ST, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of São Tomé.")}

base_plot_ST_spec

```

```{r, eval=fixed_maps_outputs$map_for_P, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of Príncipe.")}

base_plot_P_spec

```

```{r, eval=eval_diameter_plot, echo=FALSE, fig.cap=paste("Histogram of diameters of all stems identified as", taxa_name)}

combined_dataset %>% 
  filter(!is.na(id_n), tax_infra_level == taxa_name) %>% 
  dplyr::select(stem_diameter) %>% 
  ggplot() + 
  geom_histogram(mapping = aes(stem_diameter), binwidth = 1)

```

```{r, message=FALSE, echo=FALSE, warning=FALSE, results='hide'}

# figs_paths <- get_figs_paths(taxa = taxa_name)

all_files_fotos <- list.files("./images/", pattern = ".jpg")

all_files_fotos <- all_files_fotos[grepl(gsub(" ", "_", taxa_name), all_files_fotos)]

if (length(all_files_fotos) > 0) {
  
  show_foto <- TRUE
  
  copyrights <- unlist(lapply(strsplit(all_files_fotos, "_"), function(x) x[length(x)]))
  copyrights <- unlist(lapply(strsplit(copyrights, "[.]"), function(x) x[1]))
  
  caps <- paste("Copyright", copyrights)
  
} else {
  
  show_foto <- FALSE
  
}

```

```{r , eval=show_foto, echo=FALSE, fig.cap=caps, out.width = '70%'}
knitr::include_graphics(paste0("./images/", "/", all_files_fotos))
```


### ```r list_fam %>% slice(2)```


```{r, echo=FALSE, message=FALSE}

list_tax <-
  endemic_list %>% filter(tax_fam == list_fam %>% slice(2) %>% pull()) %>%
  distinct(tax_infra_level, tax_infra_level_auth) %>% arrange(tax_infra_level)

```


#### ```r list_tax %>% slice(1) %>% pull(tax_infra_level_auth)```


```{r , echo=FALSE, message=FALSE, warning=FALSE}

taxa_name <- list_tax %>% slice(1) %>% pull(tax_infra_level)

id_sp <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(idtax_f)

iucn_status <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(iucn_status)

combined_dataset_sf <- 
  combined_dataset %>%
  filter(georef_final == 1, 
         idtax_f == id_sp) %>%
  st_as_sf(coords = c("ddlon", "ddlat"))

st_crs(combined_dataset_sf) <- 4326


transect_data <- combined_dataset %>% filter(!is.na(id_n), tax_infra_level == taxa_name) %>% dplyr::select(stem_diameter) 

if (nrow(transect_data) >= 20) {
  
  eval_diameter_plot <- TRUE
  
} else {
  
  eval_diameter_plot <- FALSE
  
}


```


```{r , echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}

fixed_maps_outputs <- generate_fixed_maps(id_sp = id_sp,
                    dataset = combined_dataset, 
                    dataset_sf = combined_dataset_sf,
                    STP_list = list(P = P, ST = ST), 
                    size.legend.txt = 7, 
                    size.pts = 5, 
                    protected_areas = protected_areas, 
                    export_tiff = FALSE)

if (nrow(combined_dataset_sf) > 0) {
  make_lf_map <- TRUE
} else {
  make_lf_map <- FALSE
}

```


```{r, message=FALSE, echo=FALSE, warning=FALSE, eval=make_lf_map}

selected_sf <- generate_sp_leaflet(taxa = taxa_name, 
                                   dataset = combined_dataset_sf)

```

#### Status {.unnumbered}

```{r, echo=FALSE, out.width="20%"}

if (!is.na(iucn_status))
  knitr::include_graphics(paste0("./images/", iucn_status, ".png"))

```

#### Rationale {.unnumbered}

*Alsophila camerooniana* var. *currorii* was preliminary assessed as VU D2 (Figueiredo 2002), but not published on the IUCN Red List. This variety is a tree fern up to 3 m in height, endemic to Príncipe Island and found in lowland forest from 60 to 350 altitude. It is known from seven collections made between 1919 (Navel 136) and 1957 (Rose 400). Three of these collections do not have precise coordinates and were excluded from this assessment (Strickland s.n., Curror s.n. and Stévart s.n.). Four specimens of *Alsophila camerooniana* were collected in Príncipe from 1998 and 2016 and need further investigation to check if they can be *Alsophila camerooniana* var. *currorii* (Oliveira 98/177, 515, 1796 and Equipa Botanica do Príncipe 56) and were not used for this assessment. The four collections used for this assessment represent three occurrences, none considered as extirpated and all within Príncipe’s Natural Park (PNP). Based on a 2 x 2 km cell size, the AOO of this species is estimated as 12 km2, below the upper threshold for EN status under subcriterion B2. The EOO is calculated as 5.1 km2, below the upper threshold for CR status under subcriterion B1. Since the EOO cannot be less than the AOO, we consider the EOO as 12 km2 (the same value as AOO), which is below the upper threshold of the CR category under subcriterion B1. The three occurrences (Rio Bambu-Porco, Ôquê Pipi-Morro do Leste and Infante D. Henrique) were threatened by past plantations but are not currently threatened and represent one location and 1-3 subpopulations. *Alsophila camerooniana* var. *currorii* was probably much more widespread in the lowland forests of the South and thus we infer a reduction of the EOO, area of occupancy, and past decline in the extent and quality of its habitat, and a decline in the number of mature individuals. It is thus assessed as CR B1ab(i,ii,iii,iv,v). 


#### Habitat and ecology {.unnumbered}

The species occurs in lowland forest, between 60 and 350 in elevation.

#### Use and trade {.unnumbered}
*Alsophila camerooniana* var. *currorii* is included on the checklist of CITIES species (UNEP-WCM 2011).

#### Population {.unnumbered}
Population information is not sufficiently documented for this species, but we suggest the existence of 1-3 subpopulations.


```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in São Tomé.")}

fixed_maps_outputs$map_ST

```

```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in Príncipe.")}

fixed_maps_outputs$map_P

```

```{r, eval=make_lf_map, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="An interactive distribution map."}

knitr::include_url(paste0("https://cepf-stp-threat-flora.netlify.app/img/leaflet_", 
                          gsub(" ", "_", taxa_name), ".html"))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

if (fixed_maps_outputs$map_for_ST) {
  
  base_plot_ST_spec <-
    climate_occ_maps_ST(layers_env_ST = layers_env_ST,
                        taxa = taxa_name,
                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)
  
}


if (fixed_maps_outputs$map_for_P) {
    
 base_plot_P_spec <- climate_occ_maps_P(layers_env_P = layers_env_P, 
                                        taxa = taxa_name, 
                                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)

}


```



```{r, eval=fixed_maps_outputs$map_for_ST, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of São Tomé.")}

base_plot_ST_spec

```

```{r, eval=fixed_maps_outputs$map_for_P, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of Príncipe.")}

base_plot_P_spec

```

```{r, eval=eval_diameter_plot, echo=FALSE, fig.cap=paste("Histogram of diameters of all stems identified as", taxa_name)}

combined_dataset %>% 
  filter(!is.na(id_n), tax_infra_level == taxa_name) %>% 
  dplyr::select(stem_diameter) %>% 
  ggplot() + 
  geom_histogram(mapping = aes(stem_diameter), binwidth = 1)

```


```{r, message=FALSE, echo=FALSE, warning=FALSE, results='hide'}

# figs_paths <- get_figs_paths(taxa = taxa_name)

all_files_fotos <- list.files("./images/", pattern = ".jpg")

all_files_fotos <- all_files_fotos[grepl(gsub(" ", "_", taxa_name), all_files_fotos)]

if (length(all_files_fotos) > 0) {
  
  show_foto <- TRUE
  
  copyrights <- unlist(lapply(strsplit(all_files_fotos, "_"), function(x) x[length(x)]))
  copyrights <- unlist(lapply(strsplit(copyrights, "[.]"), function(x) x[1]))
  
  caps <- paste("Copyright", copyrights)
  
} else {
  
  show_foto <- FALSE
  
}

```

```{r , eval=show_foto, echo=FALSE, fig.cap=caps, out.width = '70%'}
knitr::include_graphics(paste0("./images/", "/", all_files_fotos))
```


#### ```r list_tax %>% slice(2) %>% pull(tax_infra_level_auth)```


```{r , echo=FALSE, message=FALSE, warning=FALSE}

taxa_name <- list_tax %>% slice(2) %>% pull(tax_infra_level)

id_sp <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(idtax_f)

iucn_status <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(iucn_status)

combined_dataset_sf <- 
  combined_dataset %>%
  filter(georef_final == 1, 
         idtax_f == id_sp) %>%
  st_as_sf(coords = c("ddlon", "ddlat"))

st_crs(combined_dataset_sf) <- 4326


transect_data <- combined_dataset %>% filter(!is.na(id_n), tax_infra_level == taxa_name) %>% dplyr::select(stem_diameter) 

if (nrow(transect_data) >= 20) {
  
  eval_diameter_plot <- TRUE
  
} else {
  
  eval_diameter_plot <- FALSE
  
}


```


```{r , echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}

fixed_maps_outputs <- generate_fixed_maps(id_sp = id_sp,
                    dataset = combined_dataset, 
                    dataset_sf = combined_dataset_sf,
                    STP_list = list(P = P, ST = ST), 
                    size.legend.txt = 7, 
                    size.pts = 5, 
                    protected_areas = protected_areas, 
                    export_tiff = FALSE)

if (nrow(combined_dataset_sf) > 0) {
  make_lf_map <- TRUE
} else {
  make_lf_map <- FALSE
}

```


```{r, message=FALSE, echo=FALSE, warning=FALSE, eval=make_lf_map}

selected_sf <- generate_sp_leaflet(taxa = taxa_name, 
                                   dataset = combined_dataset_sf)

```

#### Status {.unnumbered}

```{r, echo=FALSE, out.width="20%"}

if (!is.na(iucn_status))
  knitr::include_graphics(paste0("./images/", iucn_status, ".png"))

```

#### Rationale {.unnumbered}

*Alsophila welwitschii* is a tree fern up to 1.5 m tall. The species is endemic to the island of São Tomé. It occurs frequently in open forests on wet slopes, and secondary forests, between 100 to 1,850 m. It was previously assessed as VU (D2) by Figueiredo and Gascoigne (2001) because the population was present in a single location. This assessment was never published on the Red List and its date and the collection of new information justify its reassessment.
*Alsophila welwitschii* is known from 42 collections made between 1860 (Welwitsch 66) and 2020 (Lachenaud 2986). Two collections (Mann 41/1, 1104) do not have precise coordinates and were not taken into account for estimating the assessment parameters. The 40 remaining collections represent 29 occurrences, including nine within the PNOST and twenty outside the protected area. The occurrences of Monte Café (Welwitsch 66) and between Bom Sucesso and Lagoa Amélia (Lejoly 300 ; Almeida s.n ; Moller 2) are considered extirpated due to the dates of their collection and the type of activities (small-holder plantations) present around their georeferencing. These four occurrences have also not been taken into account for this assessment. The 25 remaining occurrences represent 1 to 3 subpopulations (the seeds of the species are mainly dispersed by wind). Based on a 2 x 2 km cell size, the AOO is estimated as 76 km², below the upper threshold of the EN status under subcriterion B2. The EOO is calculated as 288.140 km², below the upper threshold of the EN status under subcriterion B1. Two occurrences located outside the PNOST at Rio lo Grande (Ogonovszky 50) and Caminho de Vale Carmo (Figueiredo 157) are threatened by old plantations (cacao) and represent one location. Four occurrences inside PNOST in South (Ogonovszky  125 Between Elmolve and Vila Verde; Paiva 915 Between Juliana de Sousa and S. Miguel; Lachenaud 2986 Hill north of Praia São Miguel; Oliveira 431 Morro Provaz) are threatened by old plantations (cacao) and represent one location. The occurrence in the center of PNOST (Ogonovszky 157) is not threatened and represents one location. The two occurrences to the northwest of the PNOST (Paiva 1355 Diogo Vaz-Sao Manuel; Paiva 1355 Diogo Vaz. Rio Apaga Fogo) are threatened by illegal logging and represent a location. The Cascata Apaga-Foguinh occurrence (Paiva 743) is threatened by small-scale agriculture and represents one location. Occurrences along the tourist trail (Moller 3 and Monod 12010 West slope of Pico; Lejoly 269, 634 Lagoa Amélia; Randrianaivo 1612 Lagoa Amélia) represent one location and are indirectly threatened by ecotourism and invasive species reducing the quality of its habitat. The Formoso Grande (Oliveira 1187), Bombaim-Monte Formoso (Paiva 766), Milagrosa-Bombaim (Figueiredo 181) and Formoso Pequeno (Oliveira 1130) occurrences are threatened by illegal logging, and represents one location. The occurrence of Chamiço (Paiva 1030) is threatened by small-scale agriculture and represents one location. Four occurrences between Zampalma and Trás-os-Montes (Paiva 1110; Oliveira 1125; Henriques s.n; Gama s.n) are threatened by small-scale agriculture and illegal logging and represent one location. The Macambrará (Exell 111) is threatened by small-scale agriculture, and represents one location; we infer a future disappearance of this occurrence. The occurrence between St. Luís and Chamiço (Paiva 456) is threatened by small-scale agriculture and represents one location. Therefore, these 25 occurrences represent 10 locations (sensu IUCN, 2019), with regards to the most important threat (small-scale agriculture). We infer a continuing decline in the extent and quality of its habitat. We also infer a decline in its AOO, the number of mature individuals, and the number of subpopulations based on inferred future disappearance of one occurrence situated at Monte Figo. Therefore, *Alsophila welwitschii* is assessed as VU B1ab(ii,iii,iv,v)+2ab(ii,iii,iv,v).



#### Habitat and ecology {.unnumbered}

The species occurs frequently in open forests on wet slopes, and secondary forests, between 100 and 1,850 m in elevation.

#### Use and trade {.unnumbered}
There are no known uses of this species.

#### Population {.unnumbered}
Very widespread in São Tomé, the species seems to be very present in the center of the island.


```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in São Tomé.")}

fixed_maps_outputs$map_ST

```

```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in Príncipe.")}

fixed_maps_outputs$map_P

```

```{r, eval=make_lf_map, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="An interactive distribution map."}

knitr::include_url(paste0("https://cepf-stp-threat-flora.netlify.app/img/leaflet_", 
                          gsub(" ", "_", taxa_name), ".html"))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

if (fixed_maps_outputs$map_for_ST) {
  
  base_plot_ST_spec <-
    climate_occ_maps_ST(layers_env_ST = layers_env_ST,
                        taxa = taxa_name,
                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)
  
}


if (fixed_maps_outputs$map_for_P) {
    
 base_plot_P_spec <- climate_occ_maps_P(layers_env_P = layers_env_P, 
                                        taxa = taxa_name, 
                                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)

}


```



```{r, eval=fixed_maps_outputs$map_for_ST, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of São Tomé.")}

base_plot_ST_spec

```

```{r, eval=fixed_maps_outputs$map_for_P, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of Príncipe.")}

base_plot_P_spec

```

```{r, eval=eval_diameter_plot, echo=FALSE, fig.cap=paste("Histogram of diameters of all stems identified as", taxa_name)}

combined_dataset %>% 
  filter(!is.na(id_n), tax_infra_level == taxa_name) %>% 
  dplyr::select(stem_diameter) %>% 
  ggplot() + 
  geom_histogram(mapping = aes(stem_diameter), binwidth = 1)


```

```{r, message=FALSE, echo=FALSE, warning=FALSE, results='hide'}

# figs_paths <- get_figs_paths(taxa = taxa_name)

all_files_fotos <- list.files("./images/", pattern = ".jpg")

all_files_fotos <- all_files_fotos[grepl(gsub(" ", "_", taxa_name), all_files_fotos)]

if (length(all_files_fotos) > 0) {
  
  show_foto <- TRUE
  
  copyrights <- unlist(lapply(strsplit(all_files_fotos, "_"), function(x) x[length(x)]))
  copyrights <- unlist(lapply(strsplit(copyrights, "[.]"), function(x) x[1]))
  
  caps <- paste("Copyright", copyrights)
  
} else {
  
  show_foto <- FALSE
  
}

```

```{r , eval=show_foto, echo=FALSE, fig.cap=caps, out.width = '70%'}
knitr::include_graphics(paste0("./images/", "/", all_files_fotos))
```





### ```r list_fam %>% slice(3)```

```{r, echo=FALSE, message=FALSE}

list_tax <-
  endemic_list %>% filter(tax_fam == list_fam %>% slice(3) %>% pull()) %>%
  distinct(tax_infra_level, tax_infra_level_auth) %>% arrange(tax_infra_level)

```

#### ```r list_tax %>% slice(1) %>% pull(tax_infra_level_auth)```


```{r , echo=FALSE, message=FALSE, warning=FALSE}

taxa_name <- list_tax %>% slice(1) %>% pull(tax_infra_level)

id_sp <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(idtax_f)

iucn_status <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(iucn_status)

combined_dataset_sf <- 
  combined_dataset %>%
  filter(georef_final == 1, 
         idtax_f == id_sp) %>%
  st_as_sf(coords = c("ddlon", "ddlat"))

st_crs(combined_dataset_sf) <- 4326


transect_data <- combined_dataset %>% filter(!is.na(id_n), tax_infra_level == taxa_name) %>% dplyr::select(stem_diameter) 

if (nrow(transect_data) >= 20) {
  
  eval_diameter_plot <- TRUE
  
} else {
  
  eval_diameter_plot <- FALSE
  
}


```


```{r , echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}

fixed_maps_outputs <- generate_fixed_maps(id_sp = id_sp,
                    dataset = combined_dataset, 
                    dataset_sf = combined_dataset_sf,
                    STP_list = list(P = P, ST = ST), 
                    size.legend.txt = 7, 
                    size.pts = 5, 
                    protected_areas = protected_areas, 
                    export_tiff = FALSE)

if (nrow(combined_dataset_sf) > 0) {
  make_lf_map <- TRUE
} else {
  make_lf_map <- FALSE
}

```


```{r, message=FALSE, echo=FALSE, warning=FALSE, eval=make_lf_map}

selected_sf <- generate_sp_leaflet(taxa = taxa_name, 
                                   dataset = combined_dataset_sf)

```

#### Status {.unnumbered}

```{r, echo=FALSE, out.width="20%"}

if (!is.na(iucn_status))
  knitr::include_graphics(paste0("./images/", iucn_status, ".png"))

```

#### Rationale {.unnumbered}

*Dryopteris caperata* is a terrestrial plant, with a rhizome up to 90 mm long, and 10 mm in diameter, known from low and montane rain forest. It is known from 16 collections collected between 1885 (Moller 39) and 1998 (Lejoly 244; Oliveira 485, 624, 644). We consider that two occurrences, corresponding to collections made by Moller (39) and Rozeira (4974) are extirpated given that the habitat has been deeply changed in Nova Moca and Monte Café. Two other collections (Oliveira 136; Quintas 10) were not taken into account in this assessment since they are not precisely georeferenced. So, the 12 remaining collections represent twelve occurrences, two of them occurring in PNOST. Based on a 2 x 2 km cell size, the AOO of this species is estimated as 36 km2, below the upper threshold for EN status under subcriterion B2. The EOO is calculated as 98 km2, below the upper threshold for CR status under subcriterion B1. Two occurrences inside the PNOST, are not threatened and represent one location. The occurrence around Bom Sucesso is threatened by vegetable plantations and represents one location. We infer that this occurrence will disappear in nearly future. Two occurrences at Macambrara and Tras-os-Montes are threatened by agriculture activities and illegal logging and represent one location. Two occurrences made from Bombain and at the base of Pico Formoso were threatened by past coffee plantations and represent one location. The occurrence at Rio Lemba (Santa Catarina) is threatened by human disturbance, and represents one location. The occurrence made at Milagrosa is threatened by human disturbance, and represents one location. The occurrence around Poiso Alto is threatened by agriculture activities and represents one location. The occurrence at Cascata de São Nicolau is not threatened and represents one location. Therefore, these twelve occurrences represent nine locations (sensu IUCN, 2019) with regard to the most serious plausible threats (small-scale agriculture). Based on these threats and the disappearance of two occurrences, we infer past, current and future continuing decline in its AOO, the extent and the quality of its habitat, in number of locations, and number of individuals due to agriculture. *Dryopteris caperata* is thus assessed as VU B1ab(ii,iii,iv,v)+2ab(ii,iii,iv,v).


#### Habitat and ecology {.unnumbered}

The species occurs in lowland and montane rain forest, between 31 and 1,400 m in elevation.

#### Use and trade {.unnumbered}
There are no known uses of this species.

#### Population {.unnumbered}
Population information is not sufficiently known for this species, but we suggest the existence of one subpopulation.


```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in São Tomé.")}

fixed_maps_outputs$map_ST

```

```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in Príncipe.")}

fixed_maps_outputs$map_P

```

```{r, eval=make_lf_map, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="An interactive distribution map."}

knitr::include_url(paste0("https://cepf-stp-threat-flora.netlify.app/img/leaflet_", 
                          gsub(" ", "_", taxa_name), ".html"))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

if (fixed_maps_outputs$map_for_ST) {
  
  base_plot_ST_spec <-
    climate_occ_maps_ST(layers_env_ST = layers_env_ST,
                        taxa = taxa_name,
                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)
  
}


if (fixed_maps_outputs$map_for_P) {
    
 base_plot_P_spec <- climate_occ_maps_P(layers_env_P = layers_env_P, 
                                        taxa = taxa_name, 
                                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)

}


```



```{r, eval=fixed_maps_outputs$map_for_ST, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of São Tomé.")}

base_plot_ST_spec

```

```{r, eval=fixed_maps_outputs$map_for_P, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of Príncipe.")}

base_plot_P_spec

```

```{r, eval=eval_diameter_plot, echo=FALSE, fig.cap=paste("Histogram of diameters of all stems identified as", taxa_name)}

combined_dataset %>% 
  filter(!is.na(id_n), tax_infra_level == taxa_name) %>% 
  dplyr::select(stem_diameter) %>% 
  ggplot() + 
  geom_histogram(mapping = aes(stem_diameter), binwidth = 1)


```


```{r, message=FALSE, echo=FALSE, warning=FALSE, results='hide'}

figs_paths <- get_figs_paths(taxa = taxa_name)

if (any(grepl(".jpg", figs_paths$list_figs$value))) {
  
  list_fotos <- 
    figs_paths$list_figs %>% 
    filter(grepl(".jpg", value)) %>% 
    pull(value)
  
  for (i in 1:length(list_fotos))
  file.copy(
    paste0(figs_paths$path_good_foto$path, "/", list_fotos[i]),
    paste0("./images/", gsub(" ", "_", taxa_name), "_", i,".jpg"), # 
    overwrite = T,
    recursive = FALSE,
    copy.mode = TRUE,
    copy.date = FALSE
  )
  
  list_fotos <- list.files("./images/", pattern = gsub(" ", "_", taxa_name))
  
  show_foto <- TRUE
  
  # paste0(figs_paths$path_good_foto, list_fotos[1])
  
} else {
  
  show_foto <- FALSE
  
}

```

```{r , eval=show_foto, echo=FALSE, fig.cap=caps, out.width = '70%'}
knitr::include_graphics(paste0("./images/", "/", list_fotos))
```


### ```r list_tax %>% slice(2) %>% pull(tax_infra_level_auth)```


```{r , echo=FALSE, message=FALSE, warning=FALSE}

taxa_name <- list_tax %>% slice(2) %>% pull(tax_infra_level)

id_sp <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(idtax_f)

iucn_status <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(iucn_status)

combined_dataset_sf <- 
  combined_dataset %>%
  filter(georef_final == 1, 
         idtax_f == id_sp) %>%
  st_as_sf(coords = c("ddlon", "ddlat"))

st_crs(combined_dataset_sf) <- 4326


transect_data <- combined_dataset %>% filter(!is.na(id_n), tax_infra_level == taxa_name) %>% dplyr::select(stem_diameter) 

if (nrow(transect_data) >= 20) {
  
  eval_diameter_plot <- TRUE
  
} else {
  
  eval_diameter_plot <- FALSE
  
}


```


```{r , echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}

fixed_maps_outputs <- generate_fixed_maps(id_sp = id_sp,
                    dataset = combined_dataset, 
                    dataset_sf = combined_dataset_sf,
                    STP_list = list(P = P, ST = ST), 
                    size.legend.txt = 7, 
                    size.pts = 5, 
                    protected_areas = protected_areas, 
                    export_tiff = FALSE)

if (nrow(combined_dataset_sf) > 0) {
  make_lf_map <- TRUE
} else {
  make_lf_map <- FALSE
}

```


```{r, message=FALSE, echo=FALSE, warning=FALSE, eval=make_lf_map}

selected_sf <- generate_sp_leaflet(taxa = taxa_name, 
                                   dataset = combined_dataset_sf)

```

#### Status {.unnumbered}

```{r, echo=FALSE, out.width="20%"}

if (!is.na(iucn_status))
  knitr::include_graphics(paste0("./images/", iucn_status, ".png"))

```

#### Rationale {.unnumbered}

*Dryopteris cicatricata* is a herbaceous plant up to 1 m, known from the montane forest, between 1,725 and 1,930m in elevation. The species is endemic to São Tomé and is only known from one collection (Razeira 5136) made in 1958. In the literature, it is said that this taxon is only known from the type collection and that there is no problem with taxonomy. Unfortunately, we could not find this herbarium specimen and, therefore, with the information we have, we considered only the type. This collection would represent an occurrence located in the north of the PNOST assuming it still exists. Based on cell size of 2 x 2 km, the area of occupancy is estimated to be 4 km², below the upper threshold for CR status under criterion B2 (the EOO cannot be calculated). This single occurrence must be threatened by tourism and represent 1 location (sensu IUCN, 2019) with regard to the most serious plausible threat (tourism). We infer a past, current and future continuing decline in the extent and habitat quality. *Dryopteris cicatricata* is therefore assessed as CR B2ab(iii).




#### Habitat and ecology {.unnumbered}

The species is known from montane forest, between 1,725 and 1,930 m in elevation.

#### Use and trade {.unnumbered}
There are no known uses of this species.

#### Population {.unnumbered}
The species has only been collected in São Tomé. Its current distribution represents 1 subpopulation.


```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in São Tomé.")}

fixed_maps_outputs$map_ST

```

```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in Príncipe.")}

fixed_maps_outputs$map_P

```

```{r, eval=make_lf_map, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="An interactive distribution map."}

knitr::include_url(paste0("https://cepf-stp-threat-flora.netlify.app/img/leaflet_", 
                          gsub(" ", "_", taxa_name), ".html"))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

if (fixed_maps_outputs$map_for_ST) {
  
  base_plot_ST_spec <-
    climate_occ_maps_ST(layers_env_ST = layers_env_ST,
                        taxa = taxa_name,
                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)
  
}


if (fixed_maps_outputs$map_for_P) {
    
 base_plot_P_spec <- climate_occ_maps_P(layers_env_P = layers_env_P, 
                                        taxa = taxa_name, 
                                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)

}


```



```{r, eval=fixed_maps_outputs$map_for_ST, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of São Tomé.")}

base_plot_ST_spec

```

```{r, eval=fixed_maps_outputs$map_for_P, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of Príncipe.")}

base_plot_P_spec

```

```{r, eval=eval_diameter_plot, echo=FALSE, fig.cap=paste("Histogram of diameters of all stems identified as", taxa_name)}

combined_dataset %>% 
  filter(!is.na(id_n), tax_infra_level == taxa_name) %>% 
  dplyr::select(stem_diameter) %>% 
  ggplot() + 
  geom_histogram(mapping = aes(stem_diameter), binwidth = 1)


```



```{r, message=FALSE, echo=FALSE, warning=FALSE, results='hide'}

# figs_paths <- get_figs_paths(taxa = taxa_name)

all_files_fotos <- list.files("./images/", pattern = ".jpg")

all_files_fotos <- all_files_fotos[grepl(gsub(" ", "_", taxa_name), all_files_fotos)]

if (length(all_files_fotos) > 0) {
  
  show_foto <- TRUE
  
  copyrights <- unlist(lapply(strsplit(all_files_fotos, "_"), function(x) x[length(x)]))
  copyrights <- unlist(lapply(strsplit(copyrights, "[.]"), function(x) x[1]))
  
  caps <- paste("Copyright", copyrights)
  
} else {
  
  show_foto <- FALSE
  
}

```

```{r , eval=show_foto, echo=FALSE, fig.cap=caps, out.width = '70%'}
knitr::include_graphics(paste0("./images/", "/", all_files_fotos))
```




### ```r list_fam %>% slice(5)```

```{r, echo=FALSE, message=FALSE}

list_tax <-
  endemic_list %>% filter(tax_fam == list_fam %>% slice(5) %>% pull()) %>%
  distinct(tax_infra_level, tax_infra_level_auth) %>% arrange(tax_infra_level)

```

#### ```r list_tax %>% slice(1) %>% pull(tax_infra_level_auth)```


```{r , echo=FALSE, message=FALSE, warning=FALSE}

taxa_name <- list_tax %>% slice(1) %>% pull(tax_infra_level)

id_sp <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(idtax_f)

iucn_status <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(iucn_status)

combined_dataset_sf <- 
  combined_dataset %>%
  filter(georef_final == 1, 
         idtax_f == id_sp) %>%
  st_as_sf(coords = c("ddlon", "ddlat"))

st_crs(combined_dataset_sf) <- 4326


transect_data <- combined_dataset %>% filter(!is.na(id_n), tax_infra_level == taxa_name) %>% dplyr::select(stem_diameter) 

if (nrow(transect_data) >= 20) {
  
  eval_diameter_plot <- TRUE
  
} else {
  
  eval_diameter_plot <- FALSE
  
}


```


```{r , echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}

fixed_maps_outputs <- generate_fixed_maps(id_sp = id_sp,
                    dataset = combined_dataset, 
                    dataset_sf = combined_dataset_sf,
                    STP_list = list(P = P, ST = ST), 
                    size.legend.txt = 7, 
                    size.pts = 5, 
                    protected_areas = protected_areas, 
                    export_tiff = FALSE)

if (nrow(combined_dataset_sf) > 0) {
  make_lf_map <- TRUE
} else {
  make_lf_map <- FALSE
}

```


```{r, message=FALSE, echo=FALSE, warning=FALSE, eval=make_lf_map}

selected_sf <- generate_sp_leaflet(taxa = taxa_name, 
                                   dataset = combined_dataset_sf)

```

#### Status {.unnumbered}

```{r, echo=FALSE, out.width="20%"}

if (!is.na(iucn_status))
  knitr::include_graphics(paste0("./images/", iucn_status, ".png"))

```

#### Rationale {.unnumbered}

*Grammitis nigrocincta* is a fern preliminary assessed as VU D2 but not published on the IUCN Red List (Figueiredo 2002). The species is known from 18 collections made between 1956 (Monod 12162 and Thorold 2017) and 2019 (Barberá 2592), in submontane forests, between 450 and 1,852 m altitude. Two collections do not have precise coordinates and were excluded from this assessment (Rozeira s.n. and Wilde 532). The 16 remaining collections represent 15 occurrences (4 in Príncipe, 1 in São Tomé, 1 in Cameroon, 2 in Equatorial Guinea, 6 in Gabon, and 1 in Congo), none are considered as extirpated and representing seven subpopulations. Based on a 2 x 2 km cell size, the AOO of this species is estimated as 56 km2, below the upper threshold for EN status under subcriterion B2. The EOO is calculated as 229,315 km2, above the upper threshold for VU status under subcriterion B1. In Príncipe three occurrences Pico do Príncipe are not threatened and represent one location, and the occurrence at Pico Papagaio is threatened by tourism causing the decrease of the quality of the habitat and promoting invasive species spread and represents one location. In São Tomé, the only occurrence is at the top of Pico São Tomé and is threatened by tourism causing the decrease of the quality of the habitat and promoting invasive species spread representing one location. In Cameroon, the occurrence is not threatened and represents one location. In Equatorial Guinea, the two occurrences at the Parc National de Monte Alén are not threatened and represent one location. In Gabon, three occurrences around Monts de Cristal are threatened, two by logging and one by small-scale agriculture, each one representing one location. The occurrence in Tchimbélé is threatened by hydroelectric facilities and represents one location. The occurrence on the Komo is threatened by illegal logging and represents one location. In Naguila, the occurrence is not threatened and represents one location. In Congo, the occurrence on Bamba Mountain is not threatened and represents one location. Thus, the 15 occurrences of *Grammitis nigrocincta* represent 11 locations (sensu IUCN, 2019), with regard to the most serious plausible threat (logging). Due to these threats, we infer a continuing decline in the extent and quality of its habitat, almost reaching the threshold of VU status, but which cannot currently lead to consider the species under a threatened category according to criterion B. *Grammitis nigrocincta* is therefore assessed as NT.


#### Habitat and ecology {.unnumbered}

The species occurs in submontane forests, between 450 and 1,852 m in elevation.

#### Use and trade {.unnumbered}
There are no known uses of this species.

#### Population {.unnumbered}
Population information is not sufficiently known for this species, but we suggest the existence of 9 subpopulations.


```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in São Tomé.")}

fixed_maps_outputs$map_ST

```

```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in Príncipe.")}

fixed_maps_outputs$map_P

```

```{r, eval=make_lf_map, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="An interactive distribution map."}

knitr::include_url(paste0("https://cepf-stp-threat-flora.netlify.app/img/leaflet_", 
                          gsub(" ", "_", taxa_name), ".html"))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

if (fixed_maps_outputs$map_for_ST) {
  
  base_plot_ST_spec <-
    climate_occ_maps_ST(layers_env_ST = layers_env_ST,
                        taxa = taxa_name,
                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)
  
}


if (fixed_maps_outputs$map_for_P) {
    
 base_plot_P_spec <- climate_occ_maps_P(layers_env_P = layers_env_P, 
                                        taxa = taxa_name, 
                                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)

}


```



```{r, eval=fixed_maps_outputs$map_for_ST, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of São Tomé.")}

base_plot_ST_spec

```

```{r, eval=fixed_maps_outputs$map_for_P, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of Príncipe.")}

base_plot_P_spec

```

```{r, eval=eval_diameter_plot, echo=FALSE, fig.cap=paste("Histogram of diameters of all stems identified as", taxa_name)}

combined_dataset %>% 
  filter(!is.na(id_n), tax_infra_level == taxa_name) %>% 
  dplyr::select(stem_diameter) %>% 
  ggplot() + 
  geom_histogram(mapping = aes(stem_diameter), binwidth = 1)


```


```{r, message=FALSE, echo=FALSE, warning=FALSE, results='hide'}

# figs_paths <- get_figs_paths(taxa = taxa_name)

all_files_fotos <- list.files("./images/", pattern = ".jpg")

all_files_fotos <- all_files_fotos[grepl(gsub(" ", "_", taxa_name), all_files_fotos)]

if (length(all_files_fotos) > 0) {
  
  show_foto <- TRUE
  
  copyrights <- unlist(lapply(strsplit(all_files_fotos, "_"), function(x) x[length(x)]))
  copyrights <- unlist(lapply(strsplit(copyrights, "[.]"), function(x) x[1]))
  
  caps <- paste("Copyright", copyrights)
  
} else {
  
  show_foto <- FALSE
  
}

```

```{r , eval=show_foto, echo=FALSE, fig.cap=caps, out.width = '70%'}
knitr::include_graphics(paste0("./images/", "/", all_files_fotos))
```






#### ```r list_tax %>% slice(2) %>% pull(tax_infra_level_auth)```


```{r , echo=FALSE, message=FALSE, warning=FALSE}

taxa_name <- list_tax %>% slice(2) %>% pull(tax_infra_level)

id_sp <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(idtax_f)

iucn_status <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(iucn_status)

combined_dataset_sf <- 
  combined_dataset %>%
  filter(georef_final == 1, 
         idtax_f == id_sp) %>%
  st_as_sf(coords = c("ddlon", "ddlat"))

st_crs(combined_dataset_sf) <- 4326


transect_data <- combined_dataset %>% filter(!is.na(id_n), tax_infra_level == taxa_name) %>% dplyr::select(stem_diameter) 

if (nrow(transect_data) >= 20) {
  
  eval_diameter_plot <- TRUE
  
} else {
  
  eval_diameter_plot <- FALSE
  
}


```


```{r , echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}

fixed_maps_outputs <- generate_fixed_maps(id_sp = id_sp,
                    dataset = combined_dataset, 
                    dataset_sf = combined_dataset_sf,
                    STP_list = list(P = P, ST = ST), 
                    size.legend.txt = 7, 
                    size.pts = 5, 
                    protected_areas = protected_areas, 
                    export_tiff = FALSE)

if (nrow(combined_dataset_sf) > 0) {
  make_lf_map <- TRUE
} else {
  make_lf_map <- FALSE
}

```


```{r, message=FALSE, echo=FALSE, warning=FALSE, eval=make_lf_map}

selected_sf <- generate_sp_leaflet(taxa = taxa_name, 
                                   dataset = combined_dataset_sf)

```

#### Status {.unnumbered}

```{r, echo=FALSE, out.width="20%"}

if (!is.na(iucn_status))
  knitr::include_graphics(paste0("./images/", iucn_status, ".png"))

```

#### Rationale {.unnumbered}

*Stenogrammitis tomensis* is an epiphytic fern with rhizome short creeping, scaly, the scales reddish-brown to castaneous (Labiak, 2011). Although two collections (Newton 11; Quintas 11) are often cited, we consider that the attribution of the collection to Newton is a mistake. So, the species is known from only one collection made in 1888 (Quintas 11) around Pico São Tomé. This collection represents one occurrence and one subpopulation. Based on a 2 x 2 km cell size, the AOO of this species is estimated as 4 km2, below the upper threshold for CR status under Criterion B2. The EOO is not calculated. The habitat of the species is threatened by ecotourism activities. Ecotourism is the most important threat and this occurrence represents one location (sensu IUCN, 2019). Based on this threat, we infer past, current and future continuing decline in the extent and the quality of its habitat. *Stenogrammitis tomensis* is thus assessed as CR B2ab(iii).


#### Habitat and ecology {.unnumbered}

The species occurs in submontane rainforest, at 2,000 m in elevation.

#### Use and trade {.unnumbered}
There are no known uses of this species.

#### Population {.unnumbered}
Population information is not precisely known for this species.


```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in São Tomé.")}

fixed_maps_outputs$map_ST

```

```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in Príncipe.")}

fixed_maps_outputs$map_P

```

```{r, eval=make_lf_map, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="An interactive distribution map."}

knitr::include_url(paste0("https://cepf-stp-threat-flora.netlify.app/img/leaflet_", 
                          gsub(" ", "_", taxa_name), ".html"))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

if (fixed_maps_outputs$map_for_ST) {
  
  base_plot_ST_spec <-
    climate_occ_maps_ST(layers_env_ST = layers_env_ST,
                        taxa = taxa_name,
                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)
  
}


if (fixed_maps_outputs$map_for_P) {
    
 base_plot_P_spec <- climate_occ_maps_P(layers_env_P = layers_env_P, 
                                        taxa = taxa_name, 
                                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)

}


```



```{r, eval=fixed_maps_outputs$map_for_ST, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of São Tomé.")}

base_plot_ST_spec

```

```{r, eval=fixed_maps_outputs$map_for_P, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of Príncipe.")}

base_plot_P_spec

```

```{r, eval=eval_diameter_plot, echo=FALSE, fig.cap=paste("Histogram of diameters of all stems identified as", taxa_name)}

combined_dataset %>% 
  filter(!is.na(id_n), tax_infra_level == taxa_name) %>% 
  dplyr::select(stem_diameter) %>% 
  ggplot() + 
  geom_histogram(mapping = aes(stem_diameter), binwidth = 1)


```


```{r, message=FALSE, echo=FALSE, warning=FALSE, results='hide'}

# figs_paths <- get_figs_paths(taxa = taxa_name)

all_files_fotos <- list.files("./images/", pattern = ".jpg")

all_files_fotos <- all_files_fotos[grepl(gsub(" ", "_", taxa_name), all_files_fotos)]

if (length(all_files_fotos) > 0) {
  
  show_foto <- TRUE
  
  copyrights <- unlist(lapply(strsplit(all_files_fotos, "_"), function(x) x[length(x)]))
  copyrights <- unlist(lapply(strsplit(copyrights, "[.]"), function(x) x[1]))
  
  caps <- paste("Copyright", copyrights)
  
} else {
  
  show_foto <- FALSE
  
}

```

```{r , eval=show_foto, echo=FALSE, fig.cap=caps, out.width = '70%'}
knitr::include_graphics(paste0("./images/", "/", all_files_fotos))
```





### ```r list_fam %>% slice(6)```

```{r, echo=FALSE, message=FALSE}

list_tax <-
  endemic_list %>% filter(tax_fam == list_fam %>% slice(6) %>% pull()) %>%
  distinct(tax_infra_level, tax_infra_level_auth) %>% arrange(tax_infra_level)

```

#### ```r list_tax %>% slice(1) %>% pull(tax_infra_level_auth)```


```{r , echo=FALSE, message=FALSE, warning=FALSE}

taxa_name <- list_tax %>% slice(1) %>% pull(tax_infra_level)

id_sp <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(idtax_f)

iucn_status <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(iucn_status)

combined_dataset_sf <- 
  combined_dataset %>%
  filter(georef_final == 1, 
         idtax_f == id_sp) %>%
  st_as_sf(coords = c("ddlon", "ddlat"))

st_crs(combined_dataset_sf) <- 4326


transect_data <- combined_dataset %>% filter(!is.na(id_n), tax_infra_level == taxa_name) %>% dplyr::select(stem_diameter) 

if (nrow(transect_data) >= 20) {
  
  eval_diameter_plot <- TRUE
  
} else {
  
  eval_diameter_plot <- FALSE
  
}


```


```{r , echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}

fixed_maps_outputs <- generate_fixed_maps(id_sp = id_sp,
                    dataset = combined_dataset, 
                    dataset_sf = combined_dataset_sf,
                    STP_list = list(P = P, ST = ST), 
                    size.legend.txt = 7, 
                    size.pts = 5, 
                    protected_areas = protected_areas, 
                    export_tiff = FALSE)


if (nrow(combined_dataset_sf) > 0) {
  make_lf_map <- TRUE
} else {
  make_lf_map <- FALSE
}

```


```{r, message=FALSE, echo=FALSE, warning=FALSE, eval=make_lf_map}

selected_sf <- generate_sp_leaflet(taxa = taxa_name, 
                                   dataset = combined_dataset_sf)

```

#### Status {.unnumbered}

```{r, echo=FALSE, out.width="20%"}

if (!is.na(iucn_status))
  knitr::include_graphics(paste0("./images/", iucn_status, ".png"))

```

#### Rationale {.unnumbered}

*Selaginella mannii* is known from lowland and submontane forests, between 600 and 1,900 m in elevation. It is endemic to São Tomé and Príncipe and is known from 19 collections made between 1885 and 1996. We discarded five collections (Moller 80, s.n., Henriques 4, Chevallier 14552, and Mann 1108) prior to the assessment because their locality of collections is unknown or very imprecise. The 14 remaining collections represent nine occurrences and two subpopulations. Based on a 2 x 2 km cell size, the AOO of this species is estimated to be 24 km2, which falls within the limits of the EN category under Criterion B2. The EOO is calculated as 643 km2, below the upper threshold of the EN category under Criterion B1.
Five occurrences of *Selaginella mannii* are located within the PNOST and PNOP on both islands. The habitat of only one of them does not appear under threat, whereas the four other occurrences are threatened by invasive plants. Outside the park, the species is threatened by small-scale shifting agriculture and small-holder farming. Indeed, the occurrence Exell 683 is threatened by invasive plants and trampling and represents one location. The collection Moller s.n., Exell 95, 106, 168, all representing the same occurrence, are threatened by the encroachment of carrot crops and represent one location. The occurrence Monod 11784 is threatened by invasive plants and represents one location. The occurrences Rose 151, Paiva 1101, and 1104 (the last two in the same occurrence) are threatened by shifting agriculture and represent two locations. The collections Monod 11904, Paiva 190, and Moller s.n. located within the park in São Tomé are threatened by invasive plants and trampling. We have not found any threat for the occurrence Moller s.n. located within the park. Based on the smallest size of locations in the currently affected areas by small-holder farming, that occurrence represents one location. 
Based on the main threat which is small-holder farming, the nine occurrences represent seven locations (sensu IUCN 2019), which falls within the limits of the Vulnerable category under the criteria B1 and B2. Shifting agriculture and small-holder farming are leading to a continuing decline in the quality of the species' habitat. The disappearance of the occurrence from São Nicolau leads us to infer a decline in AOO, number of locations, and mature individuals of the species. For these reasons, *Selaginella mannii* is assessed as VU B1ab(ii,iii,iv,v)+2ab(ii,iii,iv,v).


#### Habitat and ecology {.unnumbered}

The species is known from lowland and submontane forests, between 600 and 1,900 m in elevation.

#### Use and trade {.unnumbered}
There are no known uses of this species.

#### Population {.unnumbered}
*Selaginella mannii* is known from two subpopulations. No quantitative population data are available for the species.


```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in São Tomé.")}

fixed_maps_outputs$map_ST

```

```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in Príncipe.")}

fixed_maps_outputs$map_P

```

```{r, eval=make_lf_map, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="An interactive distribution map."}

knitr::include_url(paste0("https://cepf-stp-threat-flora.netlify.app/img/leaflet_", 
                          gsub(" ", "_", taxa_name), ".html"))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

if (fixed_maps_outputs$map_for_ST) {
  
  base_plot_ST_spec <-
    climate_occ_maps_ST(layers_env_ST = layers_env_ST,
                        taxa = taxa_name,
                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)
  
}


if (fixed_maps_outputs$map_for_P) {
    
 base_plot_P_spec <- climate_occ_maps_P(layers_env_P = layers_env_P, 
                                        taxa = taxa_name, 
                                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)

}


```



```{r, eval=fixed_maps_outputs$map_for_ST, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of São Tomé.")}

base_plot_ST_spec

```

```{r, eval=fixed_maps_outputs$map_for_P, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of Príncipe.")}

base_plot_P_spec

```

```{r, eval=eval_diameter_plot, echo=FALSE, fig.cap=paste("Histogram of diameters of all stems identified as", taxa_name)}

combined_dataset %>% 
  filter(!is.na(id_n), tax_infra_level == taxa_name) %>% 
  dplyr::select(stem_diameter) %>% 
  ggplot() + 
  geom_histogram(mapping = aes(stem_diameter), binwidth = 1)


```


```{r, message=FALSE, echo=FALSE, warning=FALSE, results='hide'}

# figs_paths <- get_figs_paths(taxa = taxa_name)

all_files_fotos <- list.files("./images/", pattern = ".jpg")

all_files_fotos <- all_files_fotos[grepl(gsub(" ", "_", taxa_name), all_files_fotos)]

if (length(all_files_fotos) > 0) {
  
  show_foto <- TRUE
  
  copyrights <- unlist(lapply(strsplit(all_files_fotos, "_"), function(x) x[length(x)]))
  copyrights <- unlist(lapply(strsplit(copyrights, "[.]"), function(x) x[1]))
  
  caps <- paste("Copyright", copyrights)
  
} else {
  
  show_foto <- FALSE
  
}

```

```{r , eval=show_foto, echo=FALSE, fig.cap=caps, out.width = '70%'}
knitr::include_graphics(paste0("./images/", "/", all_files_fotos))
```









#### ```r list_tax %>% slice(2) %>% pull(tax_infra_level_auth)```


```{r , echo=FALSE, message=FALSE, warning=FALSE}

taxa_name <- list_tax %>% slice(2) %>% pull(tax_infra_level)

id_sp <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(idtax_f)

iucn_status <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(iucn_status)

combined_dataset_sf <- 
  combined_dataset %>%
  filter(georef_final == 1, 
         idtax_f == id_sp) %>%
  st_as_sf(coords = c("ddlon", "ddlat"))

st_crs(combined_dataset_sf) <- 4326


transect_data <- combined_dataset %>% filter(!is.na(id_n), tax_infra_level == taxa_name) %>% dplyr::select(stem_diameter) 

if (nrow(transect_data) >= 20) {
  
  eval_diameter_plot <- TRUE
  
} else {
  
  eval_diameter_plot <- FALSE
  
}


```


```{r , echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}

fixed_maps_outputs <- generate_fixed_maps(id_sp = id_sp,
                    dataset = combined_dataset, 
                    dataset_sf = combined_dataset_sf,
                    STP_list = list(P = P, ST = ST), 
                    size.legend.txt = 7, 
                    size.pts = 5, 
                    protected_areas = protected_areas, 
                    export_tiff = FALSE)


if (nrow(combined_dataset_sf) > 0) {
  make_lf_map <- TRUE
} else {
  make_lf_map <- FALSE
}

```


```{r, message=FALSE, echo=FALSE, warning=FALSE, eval=make_lf_map}

selected_sf <- generate_sp_leaflet(taxa = taxa_name, 
                                   dataset = combined_dataset_sf)

```

#### Status {.unnumbered}

```{r, echo=FALSE, out.width="20%"}

if (!is.na(iucn_status))
  knitr::include_graphics(paste0("./images/", iucn_status, ".png"))

```

#### Rationale {.unnumbered}

*Selaginella monodii* was assessed by Figueiredo et Gascoigne (2001) as CR, but this assessment has not been published by the Red List Unit. It is a fern known from six collections made between 1956 (Monod 11806) and 1999 (Figueiredo 167-169; 174). Although the habitat was very degraded in places of collection, we consider that none of all occurrences has been extirpated. So these six collections represent four occurrences (all located outside PNOST), and three subpopulations. Based on a 2 x 2 km cell size, the AOO of this species is estimated as 16 km², below the upper threshold of the EN category under subcriterion B2. The EOO is calculated as 90 km², below the upper threshold of the CR category under subcriterion B1. The occurrence at Bobo Forro (Cascata Blublu) is threatened by urbanization and horticulture activities, and represents one location. The occurrence located at Cascata de Bombaim is not threatened and represents one location. Two occurrences from Generosa and Mendes Leite are threatened by cacao plantations and hydroelectric activities which induce a decline in the number of mature individuals. They represent one location. Therefore, these six occurrences represent three locations (sensu IUCN 2019), with regards to the most important threat (hydroelectric activities). We infer a past and a future decline in the number of mature individuals. Moreover, we infer a past, current, and future continuing decline in the extent and the quality of its habitat. *Selaginella monodii* is thus assessed as EN B1ab(iii,v)+2ab(iii,v).


#### Habitat and ecology {.unnumbered}

The species occurs in low altitude rainforest, on the stones of the stream of waterfalls, between 50 and 600 m in elevation.

#### Use and trade {.unnumbered}
There are no known uses of this species.

#### Population {.unnumbered}
This species appears to be stream-dependent, so the four occurrences (two of which are located on the same stream) represent three subpopulations.


```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in São Tomé.")}

fixed_maps_outputs$map_ST

```

```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in Príncipe.")}

fixed_maps_outputs$map_P

```

```{r, eval=make_lf_map, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="An interactive distribution map."}

knitr::include_url(paste0("https://cepf-stp-threat-flora.netlify.app/img/leaflet_", 
                          gsub(" ", "_", taxa_name), ".html"))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

if (fixed_maps_outputs$map_for_ST) {
  
  base_plot_ST_spec <-
    climate_occ_maps_ST(layers_env_ST = layers_env_ST,
                        taxa = taxa_name,
                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)
  
}


if (fixed_maps_outputs$map_for_P) {
    
 base_plot_P_spec <- climate_occ_maps_P(layers_env_P = layers_env_P, 
                                        taxa = taxa_name, 
                                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)

}


```



```{r, eval=fixed_maps_outputs$map_for_ST, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of São Tomé.")}

base_plot_ST_spec

```

```{r, eval=fixed_maps_outputs$map_for_P, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of Príncipe.")}

base_plot_P_spec

```

```{r, eval=eval_diameter_plot, echo=FALSE, fig.cap=paste("Histogram of diameters of all stems identified as", taxa_name)}

combined_dataset %>% 
  filter(!is.na(id_n), tax_infra_level == taxa_name) %>% 
  dplyr::select(stem_diameter) %>% 
  ggplot() + 
  geom_histogram(mapping = aes(stem_diameter), binwidth = 1)


```


```{r, message=FALSE, echo=FALSE, warning=FALSE, results='hide'}

# figs_paths <- get_figs_paths(taxa = taxa_name)

all_files_fotos <- list.files("./images/", pattern = ".jpg")

all_files_fotos <- all_files_fotos[grepl(gsub(" ", "_", taxa_name), all_files_fotos)]

if (length(all_files_fotos) > 0) {
  
  show_foto <- TRUE
  
  copyrights <- unlist(lapply(strsplit(all_files_fotos, "_"), function(x) x[length(x)]))
  copyrights <- unlist(lapply(strsplit(copyrights, "[.]"), function(x) x[1]))
  
  caps <- paste("Copyright", copyrights)
  
} else {
  
  show_foto <- FALSE
  
}

```

```{r , eval=show_foto, echo=FALSE, fig.cap=caps, out.width = '70%'}
knitr::include_graphics(paste0("./images/", "/", all_files_fotos))
```







### ```r list_fam %>% slice(7)```

```{r, echo=FALSE, message=FALSE}

list_tax <-
  endemic_list %>% filter(tax_fam == list_fam %>% slice(7) %>% pull()) %>%
  distinct(tax_infra_level, tax_infra_level_auth) %>% arrange(tax_infra_level)

```

#### ```r list_tax %>% slice(1) %>% pull(tax_infra_level_auth)```


```{r , echo=FALSE, message=FALSE, warning=FALSE}

taxa_name <- list_tax %>% slice(1) %>% pull(tax_infra_level)

id_sp <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(idtax_f)

iucn_status <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(iucn_status)

combined_dataset_sf <- 
  combined_dataset %>%
  filter(georef_final == 1, 
         idtax_f == id_sp) %>%
  st_as_sf(coords = c("ddlon", "ddlat"))

st_crs(combined_dataset_sf) <- 4326


transect_data <- combined_dataset %>% filter(!is.na(id_n), tax_infra_level == taxa_name) %>% dplyr::select(stem_diameter) 

if (nrow(transect_data) >= 20) {
  
  eval_diameter_plot <- TRUE
  
} else {
  
  eval_diameter_plot <- FALSE
  
}


```


```{r , echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}

fixed_maps_outputs <- generate_fixed_maps(id_sp = id_sp,
                    dataset = combined_dataset, 
                    dataset_sf = combined_dataset_sf,
                    STP_list = list(P = P, ST = ST), 
                    size.legend.txt = 7, 
                    size.pts = 5, 
                    protected_areas = protected_areas, 
                    export_tiff = FALSE)

if (nrow(combined_dataset_sf) > 0) {
  make_lf_map <- TRUE
} else {
  make_lf_map <- FALSE
}
  

```


```{r, message=FALSE, echo=FALSE, warning=FALSE, eval=make_lf_map}

selected_sf <- generate_sp_leaflet(taxa = taxa_name, 
                                   dataset = combined_dataset_sf)

```

#### Status {.unnumbered}

```{r, echo=FALSE, out.width="20%"}

if (!is.na(iucn_status))
  knitr::include_graphics(paste0("./images/", iucn_status, ".png"))

```

#### Rationale {.unnumbered}

*Triplophyllum fraternum* var. *elongatum* is a fern assumed to be endemic to Príncipe Island. This variety was listed as rare in the 1997 IUCN Red List of Threatened Plants (Walter and Gillett 1998). It was then assessed as CR by Figueiredo & Gascoigne (2001), but not published in the IUCN Red List. *Triplophyllum fraternum* var. *elongatum* is known from three collections. The locality of the collection made by Mann (s.n.) in 1861 is unknown. According to Holttum (1986), additional specimens exist, collected by Barter and by Curror (s.n.) with no information regarding the collection year, habitat, or locality. Klopper & Figueiredo (2013) consider the variety as rare or extinct since no collections were made since the 19th century. No dedicated survey has been conducted to find the variety, so we can't consider it extinct. The taxon is thus known from few specimens with no locality information so that it is not possible to make any further inference about its conservation status, thus this species is assessed as DD.

#### Habitat and ecology {.unnumbered}

Habitat and ecology are unknown. Collected only in Príncipe Island, in an unknown locality described only as "forest".

#### Use and trade {.unnumbered}
There are no known uses of this species.

#### Population {.unnumbered}
There is no population information for this species.


```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in São Tomé.")}

fixed_maps_outputs$map_ST

```

```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in Príncipe.")}

fixed_maps_outputs$map_P

```

```{r, eval=make_lf_map, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="An interactive distribution map."}

knitr::include_url(paste0("https://cepf-stp-threat-flora.netlify.app/img/leaflet_", 
                          gsub(" ", "_", taxa_name), ".html"))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

if (fixed_maps_outputs$map_for_ST) {
  
  base_plot_ST_spec <-
    climate_occ_maps_ST(layers_env_ST = layers_env_ST,
                        taxa = taxa_name,
                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)
  
}


if (fixed_maps_outputs$map_for_P) {
    
 base_plot_P_spec <- climate_occ_maps_P(layers_env_P = layers_env_P, 
                                        taxa = taxa_name, 
                                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)

}


```



```{r, eval=fixed_maps_outputs$map_for_ST, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of São Tomé.")}

base_plot_ST_spec

```

```{r, eval=fixed_maps_outputs$map_for_P, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of Príncipe.")}

base_plot_P_spec

```

```{r, eval=eval_diameter_plot, echo=FALSE, fig.cap=paste("Histogram of diameters of all stems identified as", taxa_name)}

combined_dataset %>% 
  filter(!is.na(id_n), tax_infra_level == taxa_name) %>% 
  dplyr::select(stem_diameter) %>% 
  ggplot() + 
  geom_histogram(mapping = aes(stem_diameter), binwidth = 1)


```


```{r, message=FALSE, echo=FALSE, warning=FALSE, results='hide'}

# figs_paths <- get_figs_paths(taxa = taxa_name)

all_files_fotos <- list.files("./images/", pattern = ".jpg")

all_files_fotos <- all_files_fotos[grepl(gsub(" ", "_", taxa_name), all_files_fotos)]

if (length(all_files_fotos) > 0) {
  
  show_foto <- TRUE
  
  copyrights <- unlist(lapply(strsplit(all_files_fotos, "_"), function(x) x[length(x)]))
  copyrights <- unlist(lapply(strsplit(copyrights, "[.]"), function(x) x[1]))
  
  caps <- paste("Copyright", copyrights)
  
} else {
  
  show_foto <- FALSE
  
}

```

```{r , eval=show_foto, echo=FALSE, fig.cap=caps, out.width = '70%'}
knitr::include_graphics(paste0("./images/", "/", all_files_fotos))
```













### ```r list_fam %>% slice(8)```

```{r, echo=FALSE, message=FALSE}

list_tax <-
  endemic_list %>% filter(tax_fam == list_fam %>% slice(8) %>% pull()) %>%
  distinct(tax_infra_level, tax_infra_level_auth) %>% arrange(tax_infra_level)

```

#### ```r list_tax %>% slice(1) %>% pull(tax_infra_level_auth)```


```{r , echo=FALSE, message=FALSE, warning=FALSE}

taxa_name <- list_tax %>% slice(1) %>% pull(tax_infra_level)

id_sp <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(idtax_f)

iucn_status <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(iucn_status)

combined_dataset_sf <- 
  combined_dataset %>%
  filter(georef_final == 1, 
         idtax_f == id_sp) %>%
  st_as_sf(coords = c("ddlon", "ddlat"))

st_crs(combined_dataset_sf) <- 4326


transect_data <- combined_dataset %>% filter(!is.na(id_n), tax_infra_level == taxa_name) %>% dplyr::select(stem_diameter) 

if (nrow(transect_data) >= 20) {
  
  eval_diameter_plot <- TRUE
  
} else {
  
  eval_diameter_plot <- FALSE
  
}


```


```{r , echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}

fixed_maps_outputs <- generate_fixed_maps(id_sp = id_sp,
                    dataset = combined_dataset, 
                    dataset_sf = combined_dataset_sf,
                    STP_list = list(P = P, ST = ST), 
                    size.legend.txt = 7, 
                    size.pts = 5, 
                    protected_areas = protected_areas, 
                    export_tiff = FALSE)

if (nrow(combined_dataset_sf) > 0) {
  make_lf_map <- TRUE
} else {
  make_lf_map <- FALSE
}

```


```{r, message=FALSE, echo=FALSE, warning=FALSE, eval=make_lf_map}

selected_sf <- generate_sp_leaflet(taxa = taxa_name, 
                                   dataset = combined_dataset_sf)

```

#### Status {.unnumbered}

```{r, echo=FALSE, out.width="20%"}

if (!is.na(iucn_status))
  knitr::include_graphics(paste0("./images/", iucn_status, ".png"))

```

#### Rationale {.unnumbered}

*Pseudophegopteris henriquesii* (Holttum, 1969) is an herb up to 1 m, known from dense humid forest, between 600 and 1,250 m in elevation. The species is endemic to São Tomé. It is known from 10 collections made between 1885 (Moller s.n.; 45; 49) and 1998 (Paiva 1317). However, we excluded two collections because no locality information is provided. The eight remaining collections represent five occurrences and one subpopulation. Considering forest cover, which is still significant in areas of collection, we do not regard any of these five remaining occurrences as extirpated. Based on a 2 x 2 km cell size, the AOO of this species is estimated as 16 km2, below the upper threshold for EN status under subcriterion B2. The EOO is calculated as 2.5 km2, above the upper threshold for CR status under subcriteria B1. Since the EOO is less than the AOO, we consider the EOO equal to the AOO (16 km2), below the upper threshold for CR status. Two occurrences located at Nova Moca are threatened by coffee plantations and represent one location. The occurrence at Zampalma is threatened by horticulture and represents one location. We consider that this occurrence will disappear in the near future. Two occurrences at Rosa Calvario are threatened by plantations and represent one location. Therefore, these five occurrences represent three locations (sensu IUCN, 2019), with regard to the most serious plausible threats (small-scale agriculture). Based on the future disappearance of the occurrence in Zampalma, we infer a continuing decline in its AOO, EOO, the number of locations, the extent and the quality of its habitat, and the number of mature individuals. *Pseudophegopteris henriquesii* is thus assessed as EN B1ab(i,ii,iii iv,v)+2ab(i,ii,iii,iv,v).

#### Habitat and ecology {.unnumbered}

The species is known from dense humid forest, between 600 and 1,250 m in elevation.

#### Use and trade {.unnumbered}
There are no known uses of this species.

#### Population {.unnumbered}
Population information is not very well known for this species.


```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in São Tomé.")}

fixed_maps_outputs$map_ST

```

```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in Príncipe.")}

fixed_maps_outputs$map_P

```

```{r, eval=make_lf_map, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="An interactive distribution map."}

knitr::include_url(paste0("https://cepf-stp-threat-flora.netlify.app/img/leaflet_", 
                          gsub(" ", "_", taxa_name), ".html"))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

if (fixed_maps_outputs$map_for_ST) {
  
  base_plot_ST_spec <-
    climate_occ_maps_ST(layers_env_ST = layers_env_ST,
                        taxa = taxa_name,
                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)
  
}


if (fixed_maps_outputs$map_for_P) {
    
 base_plot_P_spec <- climate_occ_maps_P(layers_env_P = layers_env_P, 
                                        taxa = taxa_name, 
                                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)

}


```



```{r, eval=fixed_maps_outputs$map_for_ST, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of São Tomé.")}

base_plot_ST_spec

```

```{r, eval=fixed_maps_outputs$map_for_P, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of Príncipe.")}

base_plot_P_spec

```

```{r, eval=eval_diameter_plot, echo=FALSE, fig.cap=paste("Histogram of diameters of all stems identified as", taxa_name)}

combined_dataset %>% 
  filter(!is.na(id_n), tax_infra_level == taxa_name) %>% 
  dplyr::select(stem_diameter) %>% 
  ggplot() + 
  geom_histogram(mapping = aes(stem_diameter), binwidth = 1)


```


```{r, message=FALSE, echo=FALSE, warning=FALSE, results='hide'}

# figs_paths <- get_figs_paths(taxa = taxa_name)

all_files_fotos <- list.files("./images/", pattern = ".jpg")

all_files_fotos <- all_files_fotos[grepl(gsub(" ", "_", taxa_name), all_files_fotos)]

if (length(all_files_fotos) > 0) {
  
  show_foto <- TRUE
  
  copyrights <- unlist(lapply(strsplit(all_files_fotos, "_"), function(x) x[length(x)]))
  copyrights <- unlist(lapply(strsplit(copyrights, "[.]"), function(x) x[1]))
  
  caps <- paste("Copyright", copyrights)
  
} else {
  
  show_foto <- FALSE
  
}

```

```{r , eval=show_foto, echo=FALSE, fig.cap=caps, out.width = '70%'}
knitr::include_graphics(paste0("./images/", "/", all_files_fotos))
```






#### ```r list_tax %>% slice(2) %>% pull(tax_infra_level_auth)```


```{r , echo=FALSE, message=FALSE, warning=FALSE}

taxa_name <- list_tax %>% slice(2) %>% pull(tax_infra_level)

id_sp <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(idtax_f)

iucn_status <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(iucn_status)

combined_dataset_sf <- 
  combined_dataset %>%
  filter(georef_final == 1, 
         idtax_f == id_sp) %>%
  st_as_sf(coords = c("ddlon", "ddlat"))

st_crs(combined_dataset_sf) <- 4326


transect_data <- combined_dataset %>% filter(!is.na(id_n), tax_infra_level == taxa_name) %>% dplyr::select(stem_diameter) 

if (nrow(transect_data) >= 20) {
  
  eval_diameter_plot <- TRUE
  
} else {
  
  eval_diameter_plot <- FALSE
  
}


```


```{r , echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}

fixed_maps_outputs <- generate_fixed_maps(id_sp = id_sp,
                    dataset = combined_dataset, 
                    dataset_sf = combined_dataset_sf,
                    STP_list = list(P = P, ST = ST), 
                    size.legend.txt = 7, 
                    size.pts = 5, 
                    protected_areas = protected_areas, 
                    export_tiff = FALSE)

if (nrow(combined_dataset_sf) > 0) {
  make_lf_map <- TRUE
} else {
  make_lf_map <- FALSE
}

```


```{r, message=FALSE, echo=FALSE, warning=FALSE, eval=make_lf_map}

selected_sf <- generate_sp_leaflet(taxa = taxa_name, 
                                   dataset = combined_dataset_sf)

```

#### Status {.unnumbered}

```{r, echo=FALSE, out.width="20%"}

if (!is.na(iucn_status))
  knitr::include_graphics(paste0("./images/", iucn_status, ".png"))

```

#### Rationale {.unnumbered}

*Sphaerostephanos elatus* subsp. *thomensis* is a fern most often found on rocks in secondary forests, between 867 and 1,867 m. It is an endemic subspecies of São Tomé, known from 3 collections made between 1885 (Moller 41) and 1995 (Paiva 844). In 1998, Figueiredo emphasized the fact that this species is very rare. These three collections represent 3 occurrences and 1 or 2 subpopulations (the seeds of the species are mainly dispersed by wind).  Based on a 2 x 2 km cell size, the AOO is estimated as 8 km², below the upper threshold of the CR status under subcriterion B2. The EOO is calculated as 0.9 km², below the upper threshold of the CR status under subcriterion B1. Here the EOO is underestimated and therefore it will be equal to the AOO. The pico occurrence (Moller 41) is threatened by invasive plants and ecotourism and represents one location. This can induce degradation of its habitat. The occurrence of São Nicolau (Paiva 304) is threatened by carrot and cabbage fields, which could lead to its future disappearance and represents one location. The Cascata de São Nicolau occurrence (Paiva 844) is not threatened and represents one location. Therefore, these 3 occurrences represent 3 locations (sensu IUCN, 2019). We infer a continuing decline in EOO, AOO, habitat extent, and quality, number of locations, and number of mature individuals. *Sphaerostephanos elatus* subsp. *thomensis* is therefore assessed as EN B1ab(i,ii,iii,iv,v)+2 ab(i,ii,iii,iv,v).

#### Habitat and ecology {.unnumbered}

The species is most often found on rocks in secondary forests, between 867 and 1,867 m in elevation.

#### Use and trade {.unnumbered}
There are no known uses of this species.

#### Population {.unnumbered}
Population information is not precisely known for this subspecies.


```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in São Tomé.")}

fixed_maps_outputs$map_ST

```

```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in Príncipe.")}

fixed_maps_outputs$map_P

```

```{r, eval=make_lf_map, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="An interactive distribution map."}

knitr::include_url(paste0("https://cepf-stp-threat-flora.netlify.app/img/leaflet_", 
                          gsub(" ", "_", taxa_name), ".html"))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

if (fixed_maps_outputs$map_for_ST) {
  
  base_plot_ST_spec <-
    climate_occ_maps_ST(layers_env_ST = layers_env_ST,
                        taxa = taxa_name,
                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)
  
}


if (fixed_maps_outputs$map_for_P) {
    
 base_plot_P_spec <- climate_occ_maps_P(layers_env_P = layers_env_P, 
                                        taxa = taxa_name, 
                                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)

}


```



```{r, eval=fixed_maps_outputs$map_for_ST, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of São Tomé.")}

base_plot_ST_spec

```

```{r, eval=fixed_maps_outputs$map_for_P, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of Príncipe.")}

base_plot_P_spec

```

```{r, eval=eval_diameter_plot, echo=FALSE, fig.cap=paste("Histogram of diameters of all stems identified as", taxa_name)}

combined_dataset %>% 
  filter(!is.na(id_n), tax_infra_level == taxa_name) %>% 
  dplyr::select(stem_diameter) %>% 
  ggplot() + 
  geom_histogram(mapping = aes(stem_diameter), binwidth = 1)


```


```{r, message=FALSE, echo=FALSE, warning=FALSE, results='hide'}

# figs_paths <- get_figs_paths(taxa = taxa_name)

all_files_fotos <- list.files("./images/", pattern = ".jpg")

all_files_fotos <- all_files_fotos[grepl(gsub(" ", "_", taxa_name), all_files_fotos)]

if (length(all_files_fotos) > 0) {
  
  show_foto <- TRUE
  
  copyrights <- unlist(lapply(strsplit(all_files_fotos, "_"), function(x) x[length(x)]))
  copyrights <- unlist(lapply(strsplit(copyrights, "[.]"), function(x) x[1]))
  
  caps <- paste("Copyright", copyrights)
  
} else {
  
  show_foto <- FALSE
  
}

```

```{r , eval=show_foto, echo=FALSE, fig.cap=caps, out.width = '70%'}
knitr::include_graphics(paste0("./images/", "/", all_files_fotos))
```



## Gymnosperm

```{r, echo=FALSE, message=FALSE}

list_fam <-
  endemic_list %>% 
  filter(tax_famclass %in% c("Pinopsida")) %>% 
  distinct(tax_fam) %>% arrange(tax_fam)

```


### ```r list_fam %>% slice(1)```


```{r, echo=FALSE, message=FALSE}

list_tax <-
  endemic_list %>% filter(tax_fam == list_fam %>% slice(1) %>% pull()) %>%
  distinct(tax_infra_level, tax_infra_level_auth) %>% arrange(tax_infra_level)

```

#### ```r list_tax %>% slice(1) %>% pull(tax_infra_level_auth)```


```{r , echo=FALSE, message=FALSE, warning=FALSE}

taxa_name <- list_tax %>% slice(1) %>% pull(tax_infra_level)

id_sp <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(idtax_f)

iucn_status <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(iucn_status)

combined_dataset_sf <- 
  combined_dataset %>%
  filter(georef_final == 1, 
         idtax_f == id_sp) %>%
  st_as_sf(coords = c("ddlon", "ddlat"))

st_crs(combined_dataset_sf) <- 4326


transect_data <- combined_dataset %>% filter(!is.na(id_n), tax_infra_level == taxa_name) %>% dplyr::select(stem_diameter) 

if (nrow(transect_data) >= 20) {
  
  eval_diameter_plot <- TRUE
  
} else {
  
  eval_diameter_plot <- FALSE
  
}


```


```{r , echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}

fixed_maps_outputs <- generate_fixed_maps(id_sp = id_sp,
                    dataset = combined_dataset, 
                    dataset_sf = combined_dataset_sf,
                    STP_list = list(P = P, ST = ST), 
                    size.legend.txt = 7, 
                    size.pts = 5, 
                    protected_areas = protected_areas, 
                    export_tiff = FALSE)

if (nrow(combined_dataset_sf) > 0) {
  make_lf_map <- TRUE
} else {
  make_lf_map <- FALSE
}

```


```{r, message=FALSE, echo=FALSE, warning=FALSE, eval=make_lf_map}

selected_sf <- generate_sp_leaflet(taxa = taxa_name, 
                                   dataset = combined_dataset_sf)

```

#### Status {.unnumbered}

```{r, echo=FALSE, out.width="20%"}

if (!is.na(iucn_status))
  knitr::include_graphics(paste0("./images/", iucn_status, ".png"))

```

#### Rationale {.unnumbered}

The species was previously assessed as VUD2 in 2011. However, new data called for its reassessment. *Afrocarpus mannii* is a tree, up to 35 m tall. It is a light demanding species, found in submontane and montane forest, mostly in open habitat such as ridges, between 1216 and 2024 m in elevation. The species is endemic to São Tomé, occurring in the Northwest-center of the island. It is known from 36 collections made between 1861 (Mann 1065) and 2008 (Randrianaivo, R. 1644), 2 observations made on the MBG Transects, 3 in Macambrará, and 57 field observations (GPS points) made on the whole island. Twenty five specimens were excluded because they are cultivated (mostly around Monte Café and Saudade) or not well georeferenced (between Monte Café and the Pico). Moreover, individuals that were planted along the road of Monte Café were logged, as well as the ones cultivated in São Nicolau and Saudade. Overall, 12 specimens and 53 observations were kept, representing 65 occurrences.
Despite the old age of some collections (Mann 1065 in 1861 for example), we did not exclude any of these 65 occurrences, since the locations are remote and still covered by forest, thus considered as still suitable for the species.
Two large groups of individuals are known in the wild, one around the ridges near Lagoa Amélia, and the other on the ridge from Estação Sousa, to the Pico de São Tomé and to Morro Vilela. These two patches of individuals form one subpopulation since they are quite close (3 km) and individuals certainly exist on ridges linking these two areas (track to Escadas). The number of individuals at the top is quite limited, but the species is frequent: 51 observations of mature individuals have been made there, showing that the species is quite common along ridges, but not abundant in the wild. Indeed, we can estimate that the number of mature individuals does not exceed 1000 individuals based on the 51 observations made along the ridge to the Pico which represent around one third or one quarter of its natural habitat. Also worth noting that most tracks in the area where the species can be found are along the ridges, which is a preferential habitat for the species, making it easy to find.
The species is not directly threatened by logging but its habitat, the submontane and montane forests, has been reduced, especially in the area near Bom Sucesso, where many new crop settlements were established starting around 1980. The species was also collected near Macambrará, on the ridge, a place that is also threatened by horticulture.
Most of the about 300-400 individuals recently cultivated in the nursery of Bom Sucesso originated from young seedlings collected at Morro Esperança, near Lagoa Amélia.
Most herbarium specimens and observations were collected in the PNOST. Despite the quality of its timber, none of these places appears to be directly threatened.
The occurrences located near Macambrará are threatened by agricultural expansion and represent one location. Individuals found between Bom Sucesso and Lagoa Amélia are also threatened by agricultural expansion and by the invasive species that it promotes, and they represent one location. Finally, individuals situated at higher elevation within the protected area do not appear to be under any direct or immediate threat, and represent one location based one the impacted area of the most important threat, agriculture.
Since the habitat remains unaltered in the places of collection, and most of the occurrences are recent, we consider that the species persists in all places of occurrence. The habitat of the species does not appear to be fragmented. Based on a 2 x 2 km cell size, the AOO of this species is estimated at 28 km², and the EOO is calculated at 14.6 km², both below the upper threshold for EN status under Criterion B. The EOO is estimated to be lower than the AOO, so we consider EOO equal to the AOO (28 km²), both below the upper threshold for EN status under Criterion B.
Therefore, these 65 occurrences represent 3 locations (sensu IUCN 2019), with regards to the most important threats (small scale agriculture). Moreover, we infer a past decline of the AOO and mature individuals, and a past, current, and future continuous decline in the extent and habitat quality. Finally, the whole population of the species is situated in 1 subpopulation. This species is thus assessed as EN B1ab(ii,iii,v)+2ab(ii,iii,v); C2a(ii).


#### Habitat and ecology {.unnumbered}

*Afrocarpus mannii* is endemic to the volcanic montane of Pico de São Tomé from ca 1,216 m to the summit at 2,024 m asl. It is nowhere a large tree and at the summit it is reduced to dwarfed krummholz. It is frequent in the high montane cloud forest, which has remained almost undisturbed, especially above ca 1,500 m.
The habitat of the species is the submontane and montane rainforest, along ridges, open montane forest, and along tracks. The species is cultivated at lower altitude in plantations or as ornamental (Porto Alegre in São Tomé, Libreville).


#### Use and trade {.unnumbered}
The timber of *Afrocarpus mannii* is valuable in well-shaped large trees, which have become scarce. It is used for light construction. This species has been planted in rural areas in Cameroon and Côte d'Ivoire and probably elsewhere in West Africa as a canopy tree or windbreak for coffee plantations and as an amenity tree in villages. The local name is Pinheiro de São Tomé and it is used to treat coughs.
Some individuals have been planted at CIAT station, around 39 years ago, and they now have about 30 cm in DBH. They were producing fruits after 30 years. Many young seedlings (10 cm tall) have been collected around Lagoa Amélia (Esperança) and planted in the nursery of the Bom Sucesso Botanical Garden (10 individuals were transplanted to the garden). After 4 years, they were about 150 cm tall. Between 300 to 400 seedlings have been delivered to communities as timber trees, but no precise localities are given (Projects CARPE, ECOFAC6, FFEM).


#### Population {.unnumbered}
The population of this species is naturally small as it is confined to the ridges of a single mountain. At lower altitudes, larger trees have been felled, but they were cultivated. The number of mature individuals is less than 1000. Around 300-400 individuals have been planted these last 10 years in São Tomé.



```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in São Tomé.")}

fixed_maps_outputs$map_ST

```

```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in Príncipe.")}

fixed_maps_outputs$map_P

```

```{r, eval=make_lf_map, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="An interactive distribution map."}

knitr::include_url(paste0("https://cepf-stp-threat-flora.netlify.app/img/leaflet_", 
                          gsub(" ", "_", taxa_name), ".html"))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

if (fixed_maps_outputs$map_for_ST) {
  
  base_plot_ST_spec <-
    climate_occ_maps_ST(layers_env_ST = layers_env_ST,
                        taxa = taxa_name,
                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)
  
}


if (fixed_maps_outputs$map_for_P) {
    
 base_plot_P_spec <- climate_occ_maps_P(layers_env_P = layers_env_P, 
                                        taxa = taxa_name, 
                                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)

}


```



```{r, eval=fixed_maps_outputs$map_for_ST, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of São Tomé.")}

base_plot_ST_spec

```

```{r, eval=fixed_maps_outputs$map_for_P, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of Príncipe.")}

base_plot_P_spec

```

```{r, eval=eval_diameter_plot, echo=FALSE, fig.cap=paste("Histogram of diameters of all stems identified as", taxa_name)}

combined_dataset %>% 
  filter(!is.na(id_n), tax_infra_level == taxa_name) %>% 
  dplyr::select(stem_diameter) %>% 
  ggplot() + 
  geom_histogram(mapping = aes(stem_diameter), binwidth = 1)


```


```{r, message=FALSE, echo=FALSE, warning=FALSE, results='hide'}

# figs_paths <- get_figs_paths(taxa = taxa_name)

all_files_fotos <- list.files("./images/", pattern = ".jpg")

all_files_fotos <- all_files_fotos[grepl(gsub(" ", "_", taxa_name), all_files_fotos)]

if (length(all_files_fotos) > 0) {
  
  show_foto <- TRUE
  
  copyrights <- unlist(lapply(strsplit(all_files_fotos, "_"), function(x) x[length(x)]))
  copyrights <- unlist(lapply(strsplit(copyrights, "[.]"), function(x) x[1]))
  
  caps <- paste("Copyright", copyrights)
  
} else {
  
  show_foto <- FALSE
  
}

```

```{r , eval=show_foto, echo=FALSE, fig.cap=caps, out.width = '70%'}
knitr::include_graphics(paste0("./images/", "/", all_files_fotos))
```



## Angiosperms

```{r, echo=FALSE, message=FALSE}

list_fam <-
  endemic_list %>% 
  filter(tax_famclass %in% c("Magnoliopsida")) %>% 
  distinct(tax_fam) %>% arrange(tax_fam)

```


### ```r list_fam %>% slice(1)```


```{r, echo=FALSE, message=FALSE}

list_tax <-
  endemic_list %>% filter(tax_fam == list_fam %>% slice(1) %>% pull()) %>%
  distinct(tax_infra_level, tax_infra_level_auth) %>% arrange(tax_infra_level)

```

#### ```r list_tax %>% slice(1) %>% pull(tax_infra_level_auth)```


```{r , echo=FALSE, message=FALSE, warning=FALSE}

taxa_name <- list_tax %>% slice(1) %>% pull(tax_infra_level)

id_sp <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(idtax_f)

iucn_status <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(iucn_status)

combined_dataset_sf <- 
  combined_dataset %>%
  filter(georef_final == 1, 
         idtax_f == id_sp) %>%
  st_as_sf(coords = c("ddlon", "ddlat"))

st_crs(combined_dataset_sf) <- 4326


transect_data <- combined_dataset %>% filter(!is.na(id_n), tax_infra_level == taxa_name) %>% dplyr::select(stem_diameter) 

if (nrow(transect_data) >= 20) {
  
  eval_diameter_plot <- TRUE
  
} else {
  
  eval_diameter_plot <- FALSE
  
}


```


```{r , echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}

fixed_maps_outputs <- generate_fixed_maps(id_sp = id_sp,
                    dataset = combined_dataset, 
                    dataset_sf = combined_dataset_sf,
                    STP_list = list(P = P, ST = ST), 
                    size.legend.txt = 7, 
                    size.pts = 5, 
                    protected_areas = protected_areas, 
                    export_tiff = FALSE)

if (nrow(combined_dataset_sf) > 0) {
  make_lf_map <- TRUE
} else {
  make_lf_map <- FALSE
}

```


```{r, message=FALSE, echo=FALSE, warning=FALSE, eval=make_lf_map}

selected_sf <- generate_sp_leaflet(taxa = taxa_name, 
                                   dataset = combined_dataset_sf)

```

#### Status {.unnumbered}

```{r, echo=FALSE, out.width="20%"}

if (!is.na(iucn_status))
  knitr::include_graphics(paste0("./images/", iucn_status, ".png"))

```

#### Rationale {.unnumbered}

*Brachystephanus occidentalis* is a perennial herb or shrub up 2 m tall. The species is endemic to the island of São Tomé. It occurs frequently, especially along streams, in old-growth or secondary montane forests and cacao plantations at elevations from 110 to 1,630 m. This endemic species has a limited distribution but does not seem particularly rare. The species is known from 31 collections made between 1860 (Welwitsch 5208) and 2020 (Lachenaud 3003). Five collections (Seabra s.n., s.n.; Oliveira 1699; Mann 1096; Welwitsch 5208) do not have precise coordinates and were not taken into account for estimate the assessment parameters. The 26 remaining collections represent 17 occurrences, including nine within the Parc Natural de Obô de São Tomé (PNOST) and eight outside the protected area. These 17 current occurrences represent 2-4 subpopulations (the dissemination type is not known). Based on a 2 x 2 km cell size, the AOO is estimated as 48 km², below the upper threshold of the EN status under subcriterion B2. The EOO is calculated as 124 km², below the upper threshold of the EN status under subcriterion B1. Three occurrences were made outside the south of PNOST at Formosso Grande (Farminhão 108), near Cruzeiro (Farminhão 118), and on the way to Bombaim (Joffroy 53). They are threatened by illegal logging and represent one location. Two occurrences inside PNOST in the West (Lachenaud 3003 West of Bombaim; Ogonovszky 328 Rio Ana Chaves) are not threatened and represent one location. The occurrences that are in the buffer zone of the PNOST (Monod 11907, 12005 West slope of Pico; Rose 307 Pico; Ogonovszky 271 Pico way down to Manuel Morais; Joffroy 176, Lejoly 12 between Pico of São Tomé and Monte Castro; Matos 7572 between Pico and Morro Vilela; Matos 7390 between Pico and Roça Ponta Figo; Joffroy 184 Rio do Ouro) represent one location, indirectly threatened by tourism that reduces the quality of its habitat. The occurrence in the North West of PNOST (Joffroy 184) is threatened by illegal logging and represents one location. The occurrence of Chamiço (Paiva 1030) is threatened by small-scale agriculture and represents one location. The occurrence of Monte Figo (Paiva 208) is threatened by small-scale agriculture, and represents one location; we infer a future disappearance of this occurrence. The Nova Moca (Moller 128), Saudade (Paiva 338), and Monte Café (Moller 281; Quintas 91) occurrences are threatened by small-holder plantations (Cacao) and represent one location. Therefore, these 17 occurrences represent 7 locations (sensu IUCN, 2019), with regards to the most important threat (small-scale agriculture). We infer a continuing decline in the extent and quality of its habitat. We also infer a decline in its AOO, EOO, the number of mature individuals, and the number of subpopulations based on inferred future disappearance of one occurrence situated at Monte Figo. Therefore, *B. occidentalis* is assessed as VU B1ab(i,ii,iii,iv,v)+2ab(i,ii,iii,iv,v).


#### Habitat and ecology {.unnumbered}

The species occur frequently (especially along streams) in montane old-growth or secondary forests and in cacao plantations at elevations from 400 to 1,630 m.


#### Use and trade {.unnumbered}
There are no known uses of this species.

#### Population {.unnumbered}
Even if widespread in São Tomé, the species appears locally rare.


```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in São Tomé.")}

fixed_maps_outputs$map_ST

```

```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in Príncipe.")}

fixed_maps_outputs$map_P

```

```{r, eval=make_lf_map,  echo=FALSE, message=FALSE, warning=FALSE, fig.cap="An interactive distribution map."}

knitr::include_url(paste0("https://cepf-stp-threat-flora.netlify.app/img/leaflet_", 
                          gsub(" ", "_", taxa_name), ".html"))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

if (fixed_maps_outputs$map_for_ST) {
  
  base_plot_ST_spec <-
    climate_occ_maps_ST(layers_env_ST = layers_env_ST,
                        taxa = taxa_name,
                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)
  
}


if (fixed_maps_outputs$map_for_P) {
    
 base_plot_P_spec <- climate_occ_maps_P(layers_env_P = layers_env_P, 
                                        taxa = taxa_name, 
                                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)

}


```



```{r, eval=fixed_maps_outputs$map_for_ST, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of São Tomé.")}

base_plot_ST_spec

```

```{r, eval=fixed_maps_outputs$map_for_P, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of Príncipe.")}

base_plot_P_spec

```

```{r, eval=eval_diameter_plot, echo=FALSE, fig.cap=paste("Histogram of diameters of all stems identified as", taxa_name)}

combined_dataset %>% 
  filter(!is.na(id_n), tax_infra_level == taxa_name) %>% 
  dplyr::select(stem_diameter) %>% 
  ggplot() + 
  geom_histogram(mapping = aes(stem_diameter), binwidth = 1)


```


```{r, message=FALSE, echo=FALSE, warning=FALSE, results='hide'}

# figs_paths <- get_figs_paths(taxa = taxa_name)

all_files_fotos <- list.files("./images/", pattern = ".jpg")

all_files_fotos <- all_files_fotos[grepl(gsub(" ", "_", taxa_name), all_files_fotos)]

if (length(all_files_fotos) > 0) {
  
  show_foto <- TRUE
  
  copyrights <- unlist(lapply(strsplit(all_files_fotos, "_"), function(x) x[length(x)]))
  copyrights <- unlist(lapply(strsplit(copyrights, "[.]"), function(x) x[1]))
  
  caps <- paste("Copyright", copyrights)
  
} else {
  
  show_foto <- FALSE
  
}

```

```{r , eval=show_foto, echo=FALSE, fig.cap=caps, out.width = '70%'}
knitr::include_graphics(paste0("./images/", "/", all_files_fotos))
```








#### ```r list_tax %>% slice(2) %>% pull(tax_infra_level_auth)```


```{r , echo=FALSE, message=FALSE, warning=FALSE}

taxa_name <- list_tax %>% slice(2) %>% pull(tax_infra_level)

id_sp <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(idtax_f)

iucn_status <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(iucn_status)

combined_dataset_sf <- 
  combined_dataset %>%
  filter(georef_final == 1, 
         idtax_f == id_sp) %>%
  st_as_sf(coords = c("ddlon", "ddlat"))

st_crs(combined_dataset_sf) <- 4326


transect_data <- combined_dataset %>% filter(!is.na(id_n), tax_infra_level == taxa_name) %>% dplyr::select(stem_diameter) 

if (nrow(transect_data) >= 20) {
  
  eval_diameter_plot <- TRUE
  
} else {
  
  eval_diameter_plot <- FALSE
  
}


```


```{r , echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}

fixed_maps_outputs <- generate_fixed_maps(id_sp = id_sp,
                    dataset = combined_dataset, 
                    dataset_sf = combined_dataset_sf,
                    STP_list = list(P = P, ST = ST), 
                    size.legend.txt = 7, 
                    size.pts = 5, 
                    protected_areas = protected_areas, 
                    export_tiff = FALSE)

if (nrow(combined_dataset_sf) > 0) {
  make_lf_map <- TRUE
} else {
  make_lf_map <- FALSE
}

```


```{r, message=FALSE, echo=FALSE, warning=FALSE, eval=make_lf_map}

selected_sf <- generate_sp_leaflet(taxa = taxa_name, 
                                   dataset = combined_dataset_sf)

```

#### Status {.unnumbered}

```{r, echo=FALSE, out.width="20%"}

if (!is.na(iucn_status))
  knitr::include_graphics(paste0("./images/", iucn_status, ".png"))

```

#### Rationale {.unnumbered}

*Heteradelphia paulowilhelmia* is a small shrub, glabrescent, more rarely up to 1 m high. It is found in open places on secondary submontane rainforest around the Lago Amélia crater, open montane forest, along roads and tracks, plantations, between 600 and 1,700 m in elevation. The species is endemic to São Tomé Island and is known from 47 collections made between 1861 (Mann 1094) and 2020 (Lachenaud 3008) in the North-center and south of the island. Six occurrences (Mann 1094, Moller 198, Campos 6, Paiva 45, Chevalier 13681 and Chevalier 14577) were excluded because they are not precisely located. These 47 specimens represent 19 occurrences. Despite the old age of some collections, we consider that only one of the 19 occurrences represent individuals that are extirpated (Moller 162 at Bom Sucesso).
The habitat of the species does not appear as fragmented, so the 18 occurrences represent 1 subpopulation. Based on a 2 x 2 km cell size, the AOO of this species is estimated as 44 km2, and the EOO is calculated as 66 km2, both below the upper threshold for EN status under Criterion B.
Of the 10 occurrences located within the PNOST, 8 are located along the tourist path from Bom Sucesso to Pico São Tomé, and Lago Amélia and 2 were collected in the south part of the park. The occurrences around Lago Amélia and along the path to the Pico are threatened by invasive species, and represent one location, while the two other occurrences are not threatened, representing another location. The seven occurrences located around Bom Sucesso are threatened by field establishment. However, such open space is also profitable for this sunny lover species. The occurrence collected between S. Luís and Chamiço was threatened by former plantations; it represents one location. The occurrence at Macambara is threatened by logging but the ridge is still covered by forest, it represents one location. Overall, we can infer that the habitat of this species in this area is threatened by the invasive species that are planted to delineate the fields, and they represent one location. Finally, one occurrence collected near Bombaim (Formoso Pequeno) was threatened by past large plantations and current logging, representing one location.
Therefore, these 18 occurrences represent 6 locations (sensu IUCN 2019), with regards to the most important threat (agriculture). Moreover, we infer a past, current, and future continuing decline in the extent and habitat quality and population based on the extirpation of one occurrence at Bom Sucesso. This species is thus assessed as VU B1ab(iii,v)+2ab(iii,v).


#### Habitat and ecology {.unnumbered}

The species is known from open submontane rainforest around crater, open montane forest, along roads and tracks, plantations, between 600 and 1,700 m in elevation.

#### Use and trade {.unnumbered}
There are no known uses of this species.

#### Population {.unnumbered}
The population of this species is unknown, but it is confined to a single mountain. The species appears as locally abundant, especially in open habitat.


```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in São Tomé.")}

fixed_maps_outputs$map_ST

```

```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in Príncipe.")}

fixed_maps_outputs$map_P

```

```{r, eval=make_lf_map, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="An interactive distribution map."}

knitr::include_url(paste0("https://cepf-stp-threat-flora.netlify.app/img/leaflet_", 
                          gsub(" ", "_", taxa_name), ".html"))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

if (fixed_maps_outputs$map_for_ST) {
  
  base_plot_ST_spec <-
    climate_occ_maps_ST(layers_env_ST = layers_env_ST,
                        taxa = taxa_name,
                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)
  
}


if (fixed_maps_outputs$map_for_P) {
    
 base_plot_P_spec <- climate_occ_maps_P(layers_env_P = layers_env_P, 
                                        taxa = taxa_name, 
                                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)

}


```



```{r, eval=fixed_maps_outputs$map_for_ST, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of São Tomé.")}

base_plot_ST_spec

```

```{r, eval=fixed_maps_outputs$map_for_P, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of Príncipe.")}

base_plot_P_spec

```

```{r, eval=eval_diameter_plot, echo=FALSE, fig.cap=paste("Histogram of diameters of all stems identified as", taxa_name)}

combined_dataset %>% 
  filter(!is.na(id_n), tax_infra_level == taxa_name) %>% 
  dplyr::select(stem_diameter) %>% 
  ggplot() + 
  geom_histogram(mapping = aes(stem_diameter), binwidth = 1)


```


```{r, message=FALSE, echo=FALSE, warning=FALSE, results='hide'}

# figs_paths <- get_figs_paths(taxa = taxa_name)

all_files_fotos <- list.files("./images/", pattern = ".jpg")

all_files_fotos <- all_files_fotos[grepl(gsub(" ", "_", taxa_name), all_files_fotos)]

if (length(all_files_fotos) > 0) {
  
  show_foto <- TRUE
  
  copyrights <- unlist(lapply(strsplit(all_files_fotos, "_"), function(x) x[length(x)]))
  copyrights <- unlist(lapply(strsplit(copyrights, "[.]"), function(x) x[1]))
  
  caps <- paste("Copyright", copyrights)
  
} else {
  
  show_foto <- FALSE
  
}

```

```{r , eval=show_foto, echo=FALSE, fig.cap=caps, out.width = '70%'}
knitr::include_graphics(paste0("./images/", "/", all_files_fotos))
```










#### ```r list_tax %>% slice(3) %>% pull(tax_infra_level_auth)```


```{r , echo=FALSE, message=FALSE, warning=FALSE}

taxa_name <- list_tax %>% slice(3) %>% pull(tax_infra_level)

id_sp <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(idtax_f)

iucn_status <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(iucn_status)

combined_dataset_sf <- 
  combined_dataset %>%
  filter(georef_final == 1, 
         idtax_f == id_sp) %>%
  st_as_sf(coords = c("ddlon", "ddlat"))

st_crs(combined_dataset_sf) <- 4326


transect_data <- combined_dataset %>% filter(!is.na(id_n), tax_infra_level == taxa_name) %>% dplyr::select(stem_diameter) 

if (nrow(transect_data) >= 20) {
  
  eval_diameter_plot <- TRUE
  
} else {
  
  eval_diameter_plot <- FALSE
  
}


```


```{r , echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}

fixed_maps_outputs <- generate_fixed_maps(id_sp = id_sp,
                    dataset = combined_dataset, 
                    dataset_sf = combined_dataset_sf,
                    STP_list = list(P = P, ST = ST), 
                    size.legend.txt = 7, 
                    size.pts = 5, 
                    protected_areas = protected_areas, 
                    export_tiff = FALSE)

if (nrow(combined_dataset_sf) > 0) {
  make_lf_map <- TRUE
} else {
  make_lf_map <- FALSE
}

```


```{r, message=FALSE, echo=FALSE, warning=FALSE, eval=make_lf_map}

selected_sf <- generate_sp_leaflet(taxa = taxa_name, 
                                   dataset = combined_dataset_sf)

```

#### Status {.unnumbered}

```{r, echo=FALSE, out.width="20%"}

if (!is.na(iucn_status))
  knitr::include_graphics(paste0("./images/", iucn_status, ".png"))

```

#### Rationale {.unnumbered}

*Heteradelphia paulowilhelmia* is a small shrub, glabrescent, more rarely up to 1 m high. It is found in open places on secondary submontane rainforest around the Lago Amélia crater, open montane forest, along roads and tracks, plantations, between 600 and 1,700 m in elevation. The species is endemic to São Tomé Island and is known from 47 collections made between 1861 (Mann 1094) and 2020 (Lachenaud 3008) in the North-center and south of the island. Six occurrences (Mann 1094, Moller 198, Campos 6, Paiva 45, Chevalier 13681 and Chevalier 14577) were excluded because they are not precisely located. These 47 specimens represent 19 occurrences. Despite the old age of some collections, we consider that only one of the 19 occurrences represent individuals that are extirpated (Moller 162 at Bom Sucesso).
The habitat of the species does not appear as fragmented, so the 18 occurrences represent 1 subpopulation. Based on a 2 x 2 km cell size, the AOO of this species is estimated as 44 km2, and the EOO is calculated as 66 km2, both below the upper threshold for EN status under Criterion B.
Of the 10 occurrences located within the PNOST, 8 are located along the tourist path from Bom Sucesso to Pico São Tomé, and Lago Amélia and 2 were collected in the south part of the park. The occurrences around Lago Amélia and along the path to the Pico are threatened by invasive species, and represent one location, while the two other occurrences are not threatened, representing another location. The seven occurrences located around Bom Sucesso are threatened by field establishment. However, such open space is also profitable for this sunny lover species. The occurrence collected between S. Luís and Chamiço was threatened by former plantations; it represents one location. The occurrence at Macambara is threatened by logging but the ridge is still covered by forest, it represents one location. Overall, we can infer that the habitat of this species in this area is threatened by the invasive species that are planted to delineate the fields, and they represent one location. Finally, one occurrence collected near Bombaim (Formoso Pequeno) was threatened by past large plantations and current logging, representing one location.
Therefore, these 18 occurrences represent 6 locations (sensu IUCN 2019), with regards to the most important threat (agriculture). Moreover, we infer a past, current, and future continuing decline in the extent and habitat quality and population based on the extirpation of one occurrence at Bom Sucesso. This species is thus assessed as VU B1ab(iii,v)+2ab(iii,v).


#### Habitat and ecology {.unnumbered}

The species is known from open submontane rainforest around crater, open montane forest, along roads and tracks, plantations, between 600 and 1,700 m in elevation.

#### Use and trade {.unnumbered}
There are no known uses of this species.

#### Population {.unnumbered}
The population of this species is unknown, but it is confined to a single mountain. The species appears as locally abundant, especially in open habitat.


```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in São Tomé.")}

fixed_maps_outputs$map_ST

```

```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in Príncipe.")}

fixed_maps_outputs$map_P

```

```{r, eval=make_lf_map, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="An interactive distribution map."}

knitr::include_url(paste0("https://cepf-stp-threat-flora.netlify.app/img/leaflet_", 
                          gsub(" ", "_", taxa_name), ".html"))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

if (fixed_maps_outputs$map_for_ST) {
  
  base_plot_ST_spec <-
    climate_occ_maps_ST(layers_env_ST = layers_env_ST,
                        taxa = taxa_name,
                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)
  
}


if (fixed_maps_outputs$map_for_P) {
    
 base_plot_P_spec <- climate_occ_maps_P(layers_env_P = layers_env_P, 
                                        taxa = taxa_name, 
                                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)

}


```



```{r, eval=fixed_maps_outputs$map_for_ST, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of São Tomé.")}

base_plot_ST_spec

```

```{r, eval=fixed_maps_outputs$map_for_P, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of Príncipe.")}

base_plot_P_spec

```

```{r, eval=eval_diameter_plot, echo=FALSE, fig.cap=paste("Histogram of diameters of all stems identified as", taxa_name)}

combined_dataset %>% 
  filter(!is.na(id_n), tax_infra_level == taxa_name) %>% 
  dplyr::select(stem_diameter) %>% 
  ggplot() + 
  geom_histogram(mapping = aes(stem_diameter), binwidth = 1)


```


```{r, message=FALSE, echo=FALSE, warning=FALSE, results='hide'}

# figs_paths <- get_figs_paths(taxa = taxa_name)

all_files_fotos <- list.files("./images/", pattern = ".jpg")

all_files_fotos <- all_files_fotos[grepl(gsub(" ", "_", taxa_name), all_files_fotos)]

if (length(all_files_fotos) > 0) {
  
  show_foto <- TRUE
  
  copyrights <- unlist(lapply(strsplit(all_files_fotos, "_"), function(x) x[length(x)]))
  copyrights <- unlist(lapply(strsplit(copyrights, "[.]"), function(x) x[1]))
  
  caps <- paste("Copyright", copyrights)
  
} else {
  
  show_foto <- FALSE
  
}

```

```{r , eval=show_foto, echo=FALSE, fig.cap=caps, out.width = '70%'}
knitr::include_graphics(paste0("./images/", "/", all_files_fotos))
```




### ```r list_fam %>% slice(3)```


```{r, echo=FALSE, message=FALSE}

list_tax <-
  endemic_list %>% filter(tax_fam == list_fam %>% slice(3) %>% pull()) %>%
  distinct(tax_infra_level, tax_infra_level_auth) %>% arrange(tax_infra_level)

```

#### ```r list_tax %>% slice(1) %>% pull(tax_infra_level_auth)```


```{r , echo=FALSE, message=FALSE, warning=FALSE}

taxa_name <- list_tax %>% slice(1) %>% pull(tax_infra_level)

id_sp <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(idtax_f)

iucn_status <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(iucn_status)

combined_dataset_sf <- 
  combined_dataset %>%
  filter(georef_final == 1, 
         idtax_f == id_sp) %>%
  st_as_sf(coords = c("ddlon", "ddlat"))

st_crs(combined_dataset_sf) <- 4326


transect_data <- combined_dataset %>% filter(!is.na(id_n), tax_infra_level == taxa_name) %>% dplyr::select(stem_diameter) 

if (nrow(transect_data) >= 20) {
  
  eval_diameter_plot <- TRUE
  
} else {
  
  eval_diameter_plot <- FALSE
  
}


```


```{r , echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}

fixed_maps_outputs <- generate_fixed_maps(id_sp = id_sp,
                    dataset = combined_dataset, 
                    dataset_sf = combined_dataset_sf,
                    STP_list = list(P = P, ST = ST), 
                    size.legend.txt = 7, 
                    size.pts = 5, 
                    protected_areas = protected_areas, 
                    export_tiff = FALSE)

if (nrow(combined_dataset_sf) > 0) {
  make_lf_map <- TRUE
} else {
  make_lf_map <- FALSE
}

```


```{r, message=FALSE, echo=FALSE, warning=FALSE, eval=make_lf_map}

selected_sf <- generate_sp_leaflet(taxa = taxa_name, 
                                   dataset = combined_dataset_sf)

```

#### Status {.unnumbered}

```{r, echo=FALSE, out.width="20%"}

if (!is.na(iucn_status))
  knitr::include_graphics(paste0("./images/", iucn_status, ".png"))

```

#### Rationale {.unnumbered}

*Anisophyllea cabole* is a tree species 35–40 m tall, endemic of São Tomé and Príncipe, recorded in São Tomé Island and recently in Príncipe (consistently since 2018, but with one previous collection made in 1980). The species was assessed in 1998 as VU D2 by the World Conservation Monitoring Centre. The new information gathered in the last years justifies a new assessment. *Anisophyllea cabole* occurs in lowland forests, on low and middle elevation (77-740 m). The collection made in Angolares (Curado s.n.) does not have precise coordinates and was excluded from this assessment. *Anisophyllea cabole* is known from 30 collections and 113 observations. The 12 collections and 92 observations in Príncipe represent 28 occurrences, none of which is considered extirpated. In Príncipe, *Anisophyllea cabole* occurs in secondary forests, including on the North of the Island (two occurrences on Ôque Daniel). However, the majority of the individuals are currently concentrated in the mature forests in the South, especially around Pico do Príncipe, the valley between Pico Mesa and Barriga Branca, and the valley of Papagaio River behind Morro de Leste. All the 28 occurrences are restricted to the PNOP, representing one subpopulation, but the species was likely widespread on the lowland forests of Príncipe. In São Tomé, *Anisophyllea cabole* is known from 26 collections and 21 observations, representing 16 occurrences. The occurrence of Angolares (Curado s.n.) is considered extirpated due to palm oil plantations and the one from Roça Potó (A. J. d’Almeida s.n.) due to urban expansion. These two collections were not considered for this evaluation. The 14 remaining occurrences represent one subpopulation. Five occurrences are located within the PNOST. Based on a 2 x 2 km cell size, the AOO is estimated as 96 km², above the upper threshold EN status under subcriterion B2. The EOO is calculated to be 2,769 km², above the upper threshold for EN status under subcriterion B1. In Príncipe, the two occurrences on Azeitona forest are threatened by charcoal production and represent one location. We suggest that these two occurrences will disappear in the near future because of the high human pressure within this part of the PNP. Two occurrences located around Morro de Leste are threatened by human disturbance and represent one location. Three occurrences behind Praia Seca and the one adjacent to Rio Porco are threatened by illegal logging and represent one location. The four occurrences on the valley between Pico Mesa and Barriga Branca and the three around Rio São Tomé were threatened by large plantations during colonial times. The thirteen other occurrences are not threatened and represent one location. Therefore, these 28 occurrences represent five locations in Príncipe (sensu IUCN, 2019). In São Tomé, the occurrence on Morro Muquinqui is threatened by small-scale agriculture and represents one location, which we suggest will disappear in near future. The occurrence in Lobata is threatened by illegal logging and represents one location. The occurrence at São Miguel, although within the PNOST, was threatened by former plantations and represents one location. The occurrence in the palm plantation is threatened by palm plantation and represents one location. We suggest that this occurrence will disappear in the near future. The occurrence at Pico Macuru was threatened by logging and represents one location. The occurrence at the base of Pico Maria Fernandes was threatened by logging and represents one location. The occurrence between Pico Maria Fernandes and Zagaia was threatened by logging and represents one location. The two occurrences (Lima 18 and 67) were threatened by large plantations during colonial times and represent one location. The other seven occurrences are not threatened and represent one location. Therefore, these 14 occurrences represent eight locations in São Tomé. In summary, These 42 occurrences represent 13 locations (sensu IUCN, 2019), with regards to the most important threats (illegal logging). We thus infer a future decline in its AOO, the number of locations, and the number of mature individuals. Moreover, we infer a current and a future continuous decline in the extent and habitat quality. The species is not severely fragmented and does not meet the threshold of any threatened categories under criterion B. Additionally, although three occurrences of the species are expected to disappear in the near future (due to small-scale agriculture, charcoal and palm plantations), this cannot lead to consider the species under a threatened category according to criterion B. *Anisophyllea cabole* is therefore assessed as NT since it could belong to a threatened category in a near future.


#### Habitat and ecology {.unnumbered}

The species is known from the lowland forest, on low and middle elevation (77-740 m).


#### Use and trade {.unnumbered}
There are no known uses of this species.

#### Population {.unnumbered}
The species is widespread in the lowland forest of São Tomé and Príncipe where aggregated individuals are often found.


```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in São Tomé.")}

fixed_maps_outputs$map_ST

```

```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in Príncipe.")}

fixed_maps_outputs$map_P

```

```{r, eval=make_lf_map,  echo=FALSE, message=FALSE, warning=FALSE, fig.cap="An interactive distribution map."}

knitr::include_url(paste0("https://cepf-stp-threat-flora.netlify.app/img/leaflet_", 
                          gsub(" ", "_", taxa_name), ".html"))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

if (fixed_maps_outputs$map_for_ST) {
  
  base_plot_ST_spec <-
    climate_occ_maps_ST(layers_env_ST = layers_env_ST,
                        taxa = taxa_name,
                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)
  
}


if (fixed_maps_outputs$map_for_P) {
    
 base_plot_P_spec <- climate_occ_maps_P(layers_env_P = layers_env_P, 
                                        taxa = taxa_name, 
                                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)

}


```



```{r, eval=fixed_maps_outputs$map_for_ST, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of São Tomé.")}

base_plot_ST_spec

```

```{r, eval=fixed_maps_outputs$map_for_P, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of Príncipe.")}

base_plot_P_spec

```

```{r, eval=eval_diameter_plot, echo=FALSE, fig.cap=paste("Histogram of diameters of all stems identified as", taxa_name)}

combined_dataset %>% 
  filter(!is.na(id_n), tax_infra_level == taxa_name) %>% 
  dplyr::select(stem_diameter) %>% 
  ggplot() + 
  geom_histogram(mapping = aes(stem_diameter), binwidth = 1)


```


```{r, message=FALSE, echo=FALSE, warning=FALSE, results='hide'}

# figs_paths <- get_figs_paths(taxa = taxa_name)

all_files_fotos <- list.files("./images/", pattern = ".jpg")

all_files_fotos <- all_files_fotos[grepl(gsub(" ", "_", taxa_name), all_files_fotos)]

if (length(all_files_fotos) > 0) {
  
  show_foto <- TRUE
  
  copyrights <- unlist(lapply(strsplit(all_files_fotos, "_"), function(x) x[length(x)]))
  copyrights <- unlist(lapply(strsplit(copyrights, "[.]"), function(x) x[1]))
  
  caps <- paste("Copyright", copyrights)
  
} else {
  
  show_foto <- FALSE
  
}

```

```{r , eval=show_foto, echo=FALSE, fig.cap=caps, out.width = '70%'}
knitr::include_graphics(paste0("./images/", "/", all_files_fotos))
```












### ```r list_fam %>% slice(5)```


```{r, echo=FALSE, message=FALSE}

list_tax <-
  endemic_list %>% filter(tax_fam == list_fam %>% slice(5) %>% pull()) %>%
  distinct(tax_infra_level, tax_infra_level_auth) %>% arrange(tax_infra_level)

```

#### ```r list_tax %>% slice(2) %>% pull(tax_infra_level_auth)```


```{r , echo=FALSE, message=FALSE, warning=FALSE}

taxa_name <- list_tax %>% slice(2) %>% pull(tax_infra_level)

id_sp <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(idtax_f)

iucn_status <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(iucn_status)

combined_dataset_sf <- 
  combined_dataset %>%
  filter(georef_final == 1, 
         idtax_f == id_sp) %>%
  st_as_sf(coords = c("ddlon", "ddlat"))

st_crs(combined_dataset_sf) <- 4326


transect_data <- combined_dataset %>% filter(!is.na(id_n), tax_infra_level == taxa_name) %>% dplyr::select(stem_diameter) 

if (nrow(transect_data) >= 20) {
  
  eval_diameter_plot <- TRUE
  
} else {
  
  eval_diameter_plot <- FALSE
  
}


```


```{r , echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}

fixed_maps_outputs <- generate_fixed_maps(id_sp = id_sp,
                    dataset = combined_dataset, 
                    dataset_sf = combined_dataset_sf,
                    STP_list = list(P = P, ST = ST), 
                    size.legend.txt = 7, 
                    size.pts = 5, 
                    protected_areas = protected_areas, 
                    export_tiff = FALSE)

if (nrow(combined_dataset_sf) > 0) {
  make_lf_map <- TRUE
} else {
  make_lf_map <- FALSE
}

```


```{r, message=FALSE, echo=FALSE, warning=FALSE, eval=make_lf_map}

selected_sf <- generate_sp_leaflet(taxa = taxa_name, 
                                   dataset = combined_dataset_sf)

```

#### Status {.unnumbered}

```{r, echo=FALSE, out.width="20%"}

if (!is.na(iucn_status))
  knitr::include_graphics(paste0("./images/", iucn_status, ".png"))

```

#### Rationale {.unnumbered}

*Tabernaemontana stenosiphon* was assessed as NT in 1998. The collection of new information and changes on Red List methodology in 2001, justifies a new assessment. This tree species is endemic to São Tomé and Príncipe, found between 86 and 1867 m altitude, but mainly in the submontane and montane forest. The species can be easily mistaken for other *Tabernaemontana* species. The genus also presents at least five collections (Davide Dias 86; Príncipe Transects 787,898 and 1042, and F. de Oliveira 146) and 92 observations in Príncipe; and 14 collections and 92 observations in São Tomé, not identified at species level since only sterile material was collected. Overall, *Tabernaemontana stenosiphon* is known from 74 collections and 359 observations made between 1885 (Moller 220, 439) and 2020. We excluded nine collections because no locality information is provided (Henriques 4,28,29,30 and 31; Moller s.n. and 97, Campos 3; Welwitsch 5988) and seven with imprecise coordinates (Wilde 119, 155, 171; Oliveira 1456, 166; Matos 7304, 7579). In Príncipe, *Tabernaemontana stenosiphon* is known from 15 collections representing six occurrences, being three around Pico Mesa, one at the top of Pico do Príncipe, one behind Morro de Leste and one occurrence between Praia Lapa and Morro Caixão. All occurrences are within PNOP and none is considered extirpated. In São Tomé, it is known from 37 occurrences. We consider that eight occurrences around Bom Sucesso and Monte Café, corresponding to collections made by Espirito Santo (4493, 4609, 5040), Lejoly (67, 219), Moller (439), Matos (7313), and Randrianaivo (1593), as extirpated due to of habitat conversion for small-scale agriculture. Therefore, *Tabernaemontana stenosiphon* is known from 35 occurrences, 29 in São Tomé and six in Príncipe. Based on a 2 x 2 km cell size, its EOO is calculated to be 2,168 km², and its AOO is estimated to be 84 km², both within the limits for EN status under subcriteria B1 and B2. In Príncipe, the occurrence at the top of Pico do Príncipe is threatened by ecotourism activities and represents one location. The occurrence between Praia Lapa and Morro Caixão was threatened by past plantations and represents one location. The other three occurrences are not threatened and represent one location. These occurrences represent 1-3 subpopulations. In São Tomé 14 occurrences are found within the PNOST. Two occurrences between Nova Ceilão and Calvario (Matos 7343 and Joffroy 114) are threatened by illegal logging and represent one location, which we suggest will disappear in near future. The 12 other occurrences are not threatened and represent one location. Outside PNOST, the 15 occurrences represent nine locations (sensu IUCN, 2019). Four occurrences are threatened by illegal logging: one occurrence between Santa Clotilde and Sao Jose, one occurrence between Chamico Caminho Maya, and two occurrences at Zampalma and Tras dos Montes, representing three locations. Three occurrences (Binda to Juliana Sousa, Vale Carmo and Sao Francisco) were threatened by past plantations, representing one location each. Two occurrences at Calvario are not threatened and represent one location. One occurrence at Caminho antenna will be threatened in the near future by small-scale agriculture and logging, representing one location. Five occurrences are threatened by small-scale agriculture (Clareira de Santa Maria, Macambara, Macambara to São Nicolau, and Wilde 330 and 155) representing one location. These occurrences represent 7 populations. In summary, these 37 occurrences correspond to 14 locations (sensu IUCN, 2019), with regards to the most important threats (small-scale agriculture), and 8-10 subpopulations, within the limits of LC status. We infer a future decline in its AOO, the number of locations, and the number of mature individuals. Moreover, we infer a current and a future continuous decline in the extent and habitat quality. Although two occurrences of the species are expected to disappear in the near future due to illegal logging, which cannot lead to consider the species under a threatened category according to criterion B. *Tabernaemontana stenosiphon* is therefore assessed as LC.


#### Habitat and ecology {.unnumbered}

In São Tomé this species was described to be the most important in the near environment of the Pico Carvalho (Decock, 2013). *T. stenosiphon* has a gregarious behavior, it can reach 84 stems/ha (Lejoly, 2000) in the PNOST (São Tomé). This common upland endemic tree (Oldfield et al., 1998) form part of the characterization of the northern mist forest of São Tomé, from 1350 to 1600 m (Llopart, 2005). This species is present in montane forest, rainforest (between 800 and 1400 m of elevation) and in the cloud-forest (above 1400 m) (Christy, 2001). More generally, this species is widely distributed over the island of São Tomé between 500 to 1600 m (Oldfield et al., 1998). This species is recorded in São Tomé and Príncipe between 86 to 1867 m altitude, mostly present at high altitude, in old-growth and secondary forest.


#### Use and trade {.unnumbered}
The bark of this species is used in São Tomé, but not in Príncipe, as traditional medicine (hypotensor) and as witchcraft protection, but this use is really limited. *T. stenosiphon* can also be used for production of lumber and firewood (Carvalho et al., 2004), but this was not mentioned during a workshop in Príncipe in June 2019. Apparently the species yields rubber of good quality but in small quantity (Moller, cited by Exell, 1944), but no mention of this use could be found.

#### Population {.unnumbered}
Widespread and abundant on submontane and montane forest, mentioned as one of the most frequent tree species near to the Pico Carvalho (within PNOST) (Decock, 2013). Preliminary data indicates that the population is stable and with good regeneration capacity. Nine to ten subpopulations can be found in São Tomé and Príncipe.


```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in São Tomé.")}

fixed_maps_outputs$map_ST

```

```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in Príncipe.")}

fixed_maps_outputs$map_P

```

```{r, eval=make_lf_map,  echo=FALSE, message=FALSE, warning=FALSE, fig.cap="An interactive distribution map."}

knitr::include_url(paste0("https://cepf-stp-threat-flora.netlify.app/img/leaflet_", 
                          gsub(" ", "_", taxa_name), ".html"))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

if (fixed_maps_outputs$map_for_ST) {
  
  base_plot_ST_spec <-
    climate_occ_maps_ST(layers_env_ST = layers_env_ST,
                        taxa = taxa_name,
                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)
  
}


if (fixed_maps_outputs$map_for_P) {
    
 base_plot_P_spec <- climate_occ_maps_P(layers_env_P = layers_env_P, 
                                        taxa = taxa_name, 
                                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)

}


```



```{r, eval=fixed_maps_outputs$map_for_ST, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of São Tomé.")}

base_plot_ST_spec

```

```{r, eval=fixed_maps_outputs$map_for_P, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of Príncipe.")}

base_plot_P_spec

```

```{r, eval=eval_diameter_plot, echo=FALSE, fig.cap=paste("Histogram of diameters of all stems identified as", taxa_name)}

combined_dataset %>% 
  filter(!is.na(id_n), tax_infra_level == taxa_name) %>% 
  dplyr::select(stem_diameter) %>% 
  ggplot() + 
  geom_histogram(mapping = aes(stem_diameter), binwidth = 1)


```


```{r, message=FALSE, echo=FALSE, warning=FALSE, results='hide'}

# figs_paths <- get_figs_paths(taxa = taxa_name)

all_files_fotos <- list.files("./images/", pattern = ".jpg")

all_files_fotos <- all_files_fotos[grepl(gsub(" ", "_", taxa_name), all_files_fotos)]

if (length(all_files_fotos) > 0) {
  
  show_foto <- TRUE
  
  copyrights <- unlist(lapply(strsplit(all_files_fotos, "_"), function(x) x[length(x)]))
  copyrights <- unlist(lapply(strsplit(copyrights, "[.]"), function(x) x[1]))
  
  caps <- paste("Copyright", copyrights)
  
} else {
  
  show_foto <- FALSE
  
}

```

```{r , eval=show_foto, echo=FALSE, fig.cap=caps, out.width = '70%'}
knitr::include_graphics(paste0("./images/", "/", all_files_fotos))
```














### ```r list_fam %>% slice(7)```


```{r, echo=FALSE, message=FALSE}

list_tax <-
  endemic_list %>% filter(tax_fam == list_fam %>% slice(7) %>% pull()) %>%
  distinct(tax_infra_level, tax_infra_level_auth) %>% arrange(tax_infra_level)

```

#### ```r list_tax %>% slice(1) %>% pull(tax_infra_level_auth)```


```{r , echo=FALSE, message=FALSE, warning=FALSE}

taxa_name <- list_tax %>% slice(1) %>% pull(tax_infra_level)

id_sp <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(idtax_f)

iucn_status <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(iucn_status)

combined_dataset_sf <- 
  combined_dataset %>%
  filter(georef_final == 1, 
         idtax_f == id_sp) %>%
  st_as_sf(coords = c("ddlon", "ddlat"))

st_crs(combined_dataset_sf) <- 4326


transect_data <- combined_dataset %>% filter(!is.na(id_n), tax_infra_level == taxa_name) %>% dplyr::select(stem_diameter) 

if (nrow(transect_data) >= 20) {
  
  eval_diameter_plot <- TRUE
  
} else {
  
  eval_diameter_plot <- FALSE
  
}


```


```{r , echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}

fixed_maps_outputs <- generate_fixed_maps(id_sp = id_sp,
                    dataset = combined_dataset, 
                    dataset_sf = combined_dataset_sf,
                    STP_list = list(P = P, ST = ST), 
                    size.legend.txt = 7, 
                    size.pts = 5, 
                    protected_areas = protected_areas, 
                    export_tiff = FALSE)

if (nrow(combined_dataset_sf) > 0) {
  make_lf_map <- TRUE
} else {
  make_lf_map <- FALSE
}

```


```{r, message=FALSE, echo=FALSE, warning=FALSE, eval=make_lf_map}

selected_sf <- generate_sp_leaflet(taxa = taxa_name, 
                                   dataset = combined_dataset_sf)

```

#### Status {.unnumbered}

```{r, echo=FALSE, out.width="20%"}

if (!is.na(iucn_status))
  knitr::include_graphics(paste0("./images/", iucn_status, ".png"))

```

#### Rationale {.unnumbered}

*Impatiens buccinalis* is a herb up to 1 m, sometimes forming dense subpopulations, known from dense sub-montane rainforest, close to stream; runway edge, disturbed forest, among wet rocks; between 700 and 1,700 m in elevation. The species is endemic to São Tomé island and is known from 39 collections made between 1861 (Mann 1089) and 2020 (Ikabanga 1155, Nguema 3343) in the centre and south-centre of the island. Eight collections were made in the PNOST, and two of them were recently collected (Ikabanga 1155, Nguema 3343 made in 2020). Six collections made around Monte Café (342, 367 made in 1885; Chevalier 13656, 14305; 14287 made in 1905; Espirito Santo 168 made in 1949) and three other collections made in Bom Sucesso (Moller 291 made in 1885; Oliveira 98 made in 1998; Joffroy 110 made in 1999) are excluded from estimated parameters. These 30 specimens represent 20 occurrences. Based on a 2 x 2 km cell size, the AOO of this species is estimated as 48 km2, below the upper threshold for EN status under criterion B2. The EOO is calculated as 74 km2, below the upper threshold for CR status under criteria B1. These 20 occurrences represent one subpopulation. Given the older date of eight collections around Monte Café and Bom Sucesso, and the recent reconversion of part of the Bom Sucesso forest into plantations which affected three collections, we consider these three occurrences (represented by all of the 11 excluded collections) as extirpated. Eight occurrences are located within the PNOST and represent three locations because the northern part of the park is actually used for agriculture. Twelve occurrences are located outside of the protected area and are threatened by agricultural activities that cause the degradation of the quality of the habitat of this species. These 12 occurrences represent two locations. Therefore, these 20 occurrences represent five locations (*sensu* IUCN 2019), with regards to the most important threat (agriculture: plantations). Based on the disappearance of the occurrences around Monte Café and Bom Successo, we inferred a decline in its AOO, its EOO, the quality of its habitat, the number of locations, and the number of mature individuals. We infer a past, current and future continuing decline in the extent and the habitat quality. This species is thus assessed as EN B1ab(i,ii,iii,iv,v)+2ab(i,ii,iii,iv,v).


#### Habitat and ecology {.unnumbered}

The species occurs in dense sub-montane rainforest, close to a stream; runway edge, disturbed forest; from 600 to 1,700 m in elevation.


#### Use and trade {.unnumbered}
It is not known if the species is used.

#### Population {.unnumbered}
Population information is not known for this species.


```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in São Tomé.")}

fixed_maps_outputs$map_ST

```

```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in Príncipe.")}

fixed_maps_outputs$map_P

```

```{r, eval=make_lf_map,  echo=FALSE, message=FALSE, warning=FALSE, fig.cap="An interactive distribution map."}

knitr::include_url(paste0("https://cepf-stp-threat-flora.netlify.app/img/leaflet_", 
                          gsub(" ", "_", taxa_name), ".html"))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

if (fixed_maps_outputs$map_for_ST) {
  
  base_plot_ST_spec <-
    climate_occ_maps_ST(layers_env_ST = layers_env_ST,
                        taxa = taxa_name,
                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)
  
}


if (fixed_maps_outputs$map_for_P) {
    
 base_plot_P_spec <- climate_occ_maps_P(layers_env_P = layers_env_P, 
                                        taxa = taxa_name, 
                                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)

}


```



```{r, eval=fixed_maps_outputs$map_for_ST, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of São Tomé.")}

base_plot_ST_spec

```

```{r, eval=fixed_maps_outputs$map_for_P, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of Príncipe.")}

base_plot_P_spec

```

```{r, eval=eval_diameter_plot, echo=FALSE, fig.cap=paste("Histogram of diameters of all stems identified as", taxa_name)}

combined_dataset %>% 
  filter(!is.na(id_n), tax_infra_level == taxa_name) %>% 
  dplyr::select(stem_diameter) %>% 
  ggplot() + 
  geom_histogram(mapping = aes(stem_diameter), binwidth = 1)


```


```{r, message=FALSE, echo=FALSE, warning=FALSE, results='hide'}

# figs_paths <- get_figs_paths(taxa = taxa_name)

all_files_fotos <- list.files("./images/", pattern = ".jpg")

all_files_fotos <- all_files_fotos[grepl(gsub(" ", "_", taxa_name), all_files_fotos)]

if (length(all_files_fotos) > 0) {
  
  show_foto <- TRUE
  
  copyrights <- unlist(lapply(strsplit(all_files_fotos, "_"), function(x) x[length(x)]))
  copyrights <- unlist(lapply(strsplit(copyrights, "[.]"), function(x) x[1]))
  
  caps <- paste("Copyright", copyrights)
  
} else {
  
  show_foto <- FALSE
  
}

```

```{r , eval=show_foto, echo=FALSE, fig.cap=caps, out.width = '70%'}
knitr::include_graphics(paste0("./images/", "/", all_files_fotos))
```













#### ```r list_tax %>% slice(2) %>% pull(tax_infra_level_auth)```


```{r , echo=FALSE, message=FALSE, warning=FALSE}

taxa_name <- list_tax %>% slice(2) %>% pull(tax_infra_level)

id_sp <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(idtax_f)

iucn_status <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(iucn_status)

combined_dataset_sf <- 
  combined_dataset %>%
  filter(georef_final == 1, 
         idtax_f == id_sp) %>%
  st_as_sf(coords = c("ddlon", "ddlat"))

st_crs(combined_dataset_sf) <- 4326


transect_data <- combined_dataset %>% filter(!is.na(id_n), tax_infra_level == taxa_name) %>% dplyr::select(stem_diameter) 

if (nrow(transect_data) >= 20) {
  
  eval_diameter_plot <- TRUE
  
} else {
  
  eval_diameter_plot <- FALSE
  
}


```


```{r , echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}

fixed_maps_outputs <- generate_fixed_maps(id_sp = id_sp,
                    dataset = combined_dataset, 
                    dataset_sf = combined_dataset_sf,
                    STP_list = list(P = P, ST = ST), 
                    size.legend.txt = 7, 
                    size.pts = 5, 
                    protected_areas = protected_areas, 
                    export_tiff = FALSE)

if (nrow(combined_dataset_sf) > 0) {
  make_lf_map <- TRUE
} else {
  make_lf_map <- FALSE
}

```


```{r, message=FALSE, echo=FALSE, warning=FALSE, eval=make_lf_map}

selected_sf <- generate_sp_leaflet(taxa = taxa_name, 
                                   dataset = combined_dataset_sf)

```

#### Status {.unnumbered}

```{r, echo=FALSE, out.width="20%"}

if (!is.na(iucn_status))
  knitr::include_graphics(paste0("./images/", iucn_status, ".png"))

```

#### Rationale {.unnumbered}

*Impatiens manteroana* is a herb up to 0.5 m high, sometimes forming dense mats of individuals. It is known from dense rainforest, among wet rocks in shaded humid places; between 100 and 1,200 m in elevation. The species is endemic to Príncipe island and is known by 26 collections made between 1932 (Exell 682) and 2019 (Equipa Botanica do Príncipe 390) in the south-center of the island. Two collections (Oliveira 871, 977) were made in 2004 in the Botanical Garden of Bom Sucesso, so they were not considered for this evaluation. In Príncipe, 23 collections were made inside the protected area (PNOP) and one (Oliveira 98) outside, at Rio Banzù. Overall, these 24 specimens represent 15 occurrences, and one or two subpopulations. Considering the forest coverage, which is still important in these areas, we consider that none of the 15 occurrences has been extirpated. Based on a 2 x 2 km cell size, the AOO of this species is estimated as 28 km2, below the upper threshold of the EN category under subcriterion B2. The EOO is calculated as 21.5 km2, below the upper threshold of the CR category under subcriterion B1. Based on criterion B, the EOO value is less than the AOO, so we consider the AOO equal to the EOO (28 km2). Concerning the 14 occurrences located within the PNP, three of them located at Pico Papagaio are threatened by ecotourism and represent one location. The occurrence located in the Southern part (around Maria Correia) was threatened by past coffee plantations and represents one location. The occurrence at Pico Mesa was threatened by small-scale agriculture and represents one location. The nine other occurrences are not clearly threatened and represent one location. These 14 occurrences, therefore, represent four locations. The occurrence of Rio Banzù is threatened by palm oil and cacao plantations (large-scale agriculture) that will induce degradation of the quality of the habitat of this species. This occurrence represents one location. As a consequence, these 15 occurrences represent five locations (sensu IUCN, 2019), with regards to the most important threat (large-scale agriculture). Based on the past, current and future threats on the occurrences around Rio Banzù, Pico A Mesa and Pico Papagaio, we inferred a decline in the quality of its habitat. We could infer a future continuing decline in the extent and the quality of its habitat. *Impatiens manteroana* is thus assessed as EN B1ab(iii)+2ab(iii).


#### Habitat and ecology {.unnumbered}

The species is known from dense rainforest, among wet rocks, between 100 and 1,200 m in elevation.


#### Use and trade {.unnumbered}
It is not known if the species is used.

#### Population {.unnumbered}
Population information is not known for this species.


```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in São Tomé.")}

fixed_maps_outputs$map_ST

```

```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in Príncipe.")}

fixed_maps_outputs$map_P

```

```{r, eval=make_lf_map,  echo=FALSE, message=FALSE, warning=FALSE, fig.cap="An interactive distribution map."}

knitr::include_url(paste0("https://cepf-stp-threat-flora.netlify.app/img/leaflet_", 
                          gsub(" ", "_", taxa_name), ".html"))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

if (fixed_maps_outputs$map_for_ST) {
  
  base_plot_ST_spec <-
    climate_occ_maps_ST(layers_env_ST = layers_env_ST,
                        taxa = taxa_name,
                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)
  
}


if (fixed_maps_outputs$map_for_P) {
    
 base_plot_P_spec <- climate_occ_maps_P(layers_env_P = layers_env_P, 
                                        taxa = taxa_name, 
                                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)

}


```



```{r, eval=fixed_maps_outputs$map_for_ST, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of São Tomé.")}

base_plot_ST_spec

```

```{r, eval=fixed_maps_outputs$map_for_P, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of Príncipe.")}

base_plot_P_spec

```

```{r, eval=eval_diameter_plot, echo=FALSE, fig.cap=paste("Histogram of diameters of all stems identified as", taxa_name)}

combined_dataset %>% 
  filter(!is.na(id_n), tax_infra_level == taxa_name) %>% 
  dplyr::select(stem_diameter) %>% 
  ggplot() + 
  geom_histogram(mapping = aes(stem_diameter), binwidth = 1)


```


```{r, message=FALSE, echo=FALSE, warning=FALSE, results='hide'}

# figs_paths <- get_figs_paths(taxa = taxa_name)

all_files_fotos <- list.files("./images/", pattern = ".jpg")

all_files_fotos <- all_files_fotos[grepl(gsub(" ", "_", taxa_name), all_files_fotos)]

if (length(all_files_fotos) > 0) {
  
  show_foto <- TRUE
  
  copyrights <- unlist(lapply(strsplit(all_files_fotos, "_"), function(x) x[length(x)]))
  copyrights <- unlist(lapply(strsplit(copyrights, "[.]"), function(x) x[1]))
  
  caps <- paste("Copyright", copyrights)
  
} else {
  
  show_foto <- FALSE
  
}

```

```{r , eval=show_foto, echo=FALSE, fig.cap=caps, out.width = '70%'}
knitr::include_graphics(paste0("./images/", "/", all_files_fotos))
```












#### ```r list_tax %>% slice(3) %>% pull(tax_infra_level_auth)```


```{r , echo=FALSE, message=FALSE, warning=FALSE}

taxa_name <- list_tax %>% slice(3) %>% pull(tax_infra_level)

id_sp <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(idtax_f)

iucn_status <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(iucn_status)

combined_dataset_sf <- 
  combined_dataset %>%
  filter(georef_final == 1, 
         idtax_f == id_sp) %>%
  st_as_sf(coords = c("ddlon", "ddlat"))

st_crs(combined_dataset_sf) <- 4326


transect_data <- combined_dataset %>% filter(!is.na(id_n), tax_infra_level == taxa_name) %>% dplyr::select(stem_diameter) 

if (nrow(transect_data) >= 20) {
  
  eval_diameter_plot <- TRUE
  
} else {
  
  eval_diameter_plot <- FALSE
  
}


```


```{r , echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}

fixed_maps_outputs <- generate_fixed_maps(id_sp = id_sp,
                    dataset = combined_dataset, 
                    dataset_sf = combined_dataset_sf,
                    STP_list = list(P = P, ST = ST), 
                    size.legend.txt = 7, 
                    size.pts = 5, 
                    protected_areas = protected_areas, 
                    export_tiff = FALSE)

if (nrow(combined_dataset_sf) > 0) {
  make_lf_map <- TRUE
} else {
  make_lf_map <- FALSE
}

```


```{r, message=FALSE, echo=FALSE, warning=FALSE, eval=make_lf_map}

selected_sf <- generate_sp_leaflet(taxa = taxa_name, 
                                   dataset = combined_dataset_sf)

```

#### Status {.unnumbered}

```{r, echo=FALSE, out.width="20%"}

if (!is.na(iucn_status))
  knitr::include_graphics(paste0("./images/", iucn_status, ".png"))

```

#### Rationale {.unnumbered}

*Impatiens thomensis* (Exell, 1944) is an herb, shrublet, or shrub (Soares, 2007) up to 1 m, known from lowland and submontane rainforest, close to stream; runway edge, disturbed forest, among wet rocks; between 10 and 1,700 m in elevation. The species is endemic to São Tomé island and is known from 29 collections made between 1932 (Exell 433) and 2019 (D'Haijère 277) mostly in the Center and South-center of the island. Although the habitat was very degraded in places of collection, we consider that none of all occurrences has been extirpated. These 29 specimens represent 21 occurrences (five of them located within Park Natural de Obô de São Tomé or PNOST) and one or two subpopulations. Based on a 2 x 2 km cell size, the AOO of this species is estimated as 68 km², below the upper threshold of the EN category under subcriterion B2. The EOO is calculated as 236 km², below the upper threshold of the EN category under subcriterion B1. Inside PNOST, two occurrences located along tourism paths are threatened by ecotourism activities and represent one location. The three other locations are not threatened and represent one location. Outside PNOST, two occurrences at São Nicolau are threatened by horticulture and represent one location. We consider that these three occurrences will disappear in the near future. However, the occurrence located at Cascata de São Nicolau is not threatened and represents one location. Five occurrences at Tràs-os-Montes are threatened by plantations and illegal logging and represent one location. Two occurrences located at Formosa are threatened by plantations and represent one location. The occurrence at São João da Vargem is threatened by urbanization and represents one location. Although this occurrence corresponds to a collection made in 2005 (documented by Oliveira 995), we consider that these three occurrences will disappear in near future. Four occurrences located at Santa Catarina are threatened by housing and small-scale agriculture activities and represent one location. The occurrence at Formiga is threatened by cacao plantations and represents one location. Therefore, these 29 occurrences represent nine locations (*sensu* IUCN 2019), with regards to the most important threat (small-scale agriculture). We infer a past, and a future continuing decline in its EOO, AOO, the number of locations, and the number of mature individuals. Moreover, we infer a past, current, and future continuing decline in the extent and the quality of its habitat. *Impatiens thomensis* is thus assessed as VU B1ab(i,ii,iii,iv,v)+2ab(i,ii,iii,iv,v).


#### Habitat and ecology {.unnumbered}
The species occurs in dense lowland and submontane rainforest, near the waterfall, on a very wet rock wall, edge of runway; between 10 and 1,700 m in elevation.


#### Use and trade {.unnumbered}
It is not known if the species is used.

#### Population {.unnumbered}
Population information is not precisely known for this species, but we consider the existence of one or two subpopulations.


```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in São Tomé.")}

fixed_maps_outputs$map_ST

```

```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in Príncipe.")}

fixed_maps_outputs$map_P

```

```{r, eval=make_lf_map,  echo=FALSE, message=FALSE, warning=FALSE, fig.cap="An interactive distribution map."}

knitr::include_url(paste0("https://cepf-stp-threat-flora.netlify.app/img/leaflet_", 
                          gsub(" ", "_", taxa_name), ".html"))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

if (fixed_maps_outputs$map_for_ST) {
  
  base_plot_ST_spec <-
    climate_occ_maps_ST(layers_env_ST = layers_env_ST,
                        taxa = taxa_name,
                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)
  
}


if (fixed_maps_outputs$map_for_P) {
    
 base_plot_P_spec <- climate_occ_maps_P(layers_env_P = layers_env_P, 
                                        taxa = taxa_name, 
                                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)

}


```



```{r, eval=fixed_maps_outputs$map_for_ST, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of São Tomé.")}

base_plot_ST_spec

```

```{r, eval=fixed_maps_outputs$map_for_P, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of Príncipe.")}

base_plot_P_spec

```

```{r, eval=eval_diameter_plot, echo=FALSE, fig.cap=paste("Histogram of diameters of all stems identified as", taxa_name)}

combined_dataset %>% 
  filter(!is.na(id_n), tax_infra_level == taxa_name) %>% 
  dplyr::select(stem_diameter) %>% 
  ggplot() + 
  geom_histogram(mapping = aes(stem_diameter), binwidth = 1)


```


```{r, message=FALSE, echo=FALSE, warning=FALSE, results='hide'}

# figs_paths <- get_figs_paths(taxa = taxa_name)

all_files_fotos <- list.files("./images/", pattern = ".jpg")

all_files_fotos <- all_files_fotos[grepl(gsub(" ", "_", taxa_name), all_files_fotos)]

if (length(all_files_fotos) > 0) {
  
  show_foto <- TRUE
  
  copyrights <- unlist(lapply(strsplit(all_files_fotos, "_"), function(x) x[length(x)]))
  copyrights <- unlist(lapply(strsplit(copyrights, "[.]"), function(x) x[1]))
  
  caps <- paste("Copyright", copyrights)
  
} else {
  
  show_foto <- FALSE
  
}

```

```{r , eval=show_foto, echo=FALSE, fig.cap=caps, out.width = '70%'}
knitr::include_graphics(paste0("./images/", "/", all_files_fotos))
```





### ```r list_fam %>% slice(8)```


```{r, echo=FALSE, message=FALSE}

list_tax <-
  endemic_list %>% filter(tax_fam == list_fam %>% slice(8) %>% pull()) %>%
  distinct(tax_infra_level, tax_infra_level_auth) %>% arrange(tax_infra_level)

```

#### ```r list_tax %>% slice(1) %>% pull(tax_infra_level_auth)```


```{r , echo=FALSE, message=FALSE, warning=FALSE}

taxa_name <- list_tax %>% slice(1) %>% pull(tax_infra_level)

id_sp <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(idtax_f)

iucn_status <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(iucn_status)

combined_dataset_sf <- 
  combined_dataset %>%
  filter(georef_final == 1, 
         idtax_f == id_sp) %>%
  st_as_sf(coords = c("ddlon", "ddlat"))

st_crs(combined_dataset_sf) <- 4326


transect_data <- combined_dataset %>% filter(!is.na(id_n), tax_infra_level == taxa_name) %>% dplyr::select(stem_diameter) 

if (nrow(transect_data) >= 20) {
  
  eval_diameter_plot <- TRUE
  
} else {
  
  eval_diameter_plot <- FALSE
  
}


```


```{r , echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}

fixed_maps_outputs <- generate_fixed_maps(id_sp = id_sp,
                    dataset = combined_dataset, 
                    dataset_sf = combined_dataset_sf,
                    STP_list = list(P = P, ST = ST), 
                    size.legend.txt = 7, 
                    size.pts = 5, 
                    protected_areas = protected_areas, 
                    export_tiff = FALSE)

if (nrow(combined_dataset_sf) > 0) {
  make_lf_map <- TRUE
} else {
  make_lf_map <- FALSE
}

```


```{r, message=FALSE, echo=FALSE, warning=FALSE, eval=make_lf_map}

selected_sf <- generate_sp_leaflet(taxa = taxa_name, 
                                   dataset = combined_dataset_sf)

```

#### Status {.unnumbered}

```{r, echo=FALSE, out.width="20%"}

if (!is.na(iucn_status))
  knitr::include_graphics(paste0("./images/", iucn_status, ".png"))

```

#### Rationale {.unnumbered}

*Begonia annobonensis* is a herb, 50 cm high, known from volcanic rock near the coast, old fallow, cocoa plantation, and old buildings; below 1,000 m in elevation. The species is known from 26 collections made between 1841 (Curror 9) and 2014 (Berthold & Gardner 49) in São Tomé and Príncipe, Annobón (Equatorial Guinea) and Cameroon. The preferential habitat is rocky cliffs, which is little or not impacted in the area where the species occurs. We consider that none of the occurrences is extirpated. One collection (Quintas 143) is not precisely located, so it is not considered for this evaluation. These 25 collections represent 24 occurrences and 4 or 5 subpopulations. Based on a 2 x 2 km cell size, the AOO  of this species is estimated as 76 km2, below the upper threshold for EN status under subcriterion B2. The EOO is calculated as 35,214 km2, above the upper threshold for VU status under subcriteria B1. In Annobón, the two occurrences located around San Antonio are threatened by urbanization, and represent one location; the three other occurrences located outside the protected area are threatened by sand extraction, and represent another location; and the two occurrences within Annobón Natural Reserve represent a third location. The occurrence located in the north of Príncipe island is threatened by coconut plantation and represents one location. In Cameroon, the occurrence located at Limbé is threatened by urbanization and agriculture activities, and the one of Batoké is threatened by oil palm plantations. No threat is known for the occurrence in Rio del Rey. So, these three occurrences represent three locations. In São Tomé, the five occurrences located between Santa Catarina and Ponta Figo (outside PNOST) are threatened by small-scale agriculture and represent one location. The two occurrences located around São Miguel are threatened by past large-scale agriculture and represent one location. The occurrence located around Binda is threatened by large-scale agriculture. The occurrence located at Vila Clothilde is threatened by oil palm plantations. These two occurrences represent two locations. The two occurrences located at Monte Cabumbé and Rio Fugo (within PNOST) are not threatened and represent together one location. The two other occurrences located within the PNOST are also threatened by small-scale agriculture, and represent one location. Therefore, these 24 occurrences represent 12 locations (sensu IUCN, 2019), with regard to the most serious plausible threats (large-scale agriculture and urbanization). Based on urbanization at Limbé and San Antonio de Palé, we expect that two occurrences will disappear in a near future, and the species would become threatened. We thus infer a future decline in its AOO, its EOO, the number of locations, and the number of mature individuals. Moreover, we infer a current and a future continuing decline in the extent and habitat quality. *B. annobonensis* is thus assessed as NT as it nearly qualifies for listing as VU B2ab(i,ii,iii,iv,v).


#### Habitat and ecology {.unnumbered}

The species grows mostly on volcanic rocks near the coast, sometimes also on old buildings, old fallow, and cocoa plantation; below 1,000 m in elevation.


#### Use and trade {.unnumbered}
It is not known if the species is used.

#### Population {.unnumbered}
Population information is not known for this species.


```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in São Tomé.")}

fixed_maps_outputs$map_ST

```

```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in Príncipe.")}

fixed_maps_outputs$map_P

```

```{r, eval=make_lf_map,  echo=FALSE, message=FALSE, warning=FALSE, fig.cap="An interactive distribution map."}

knitr::include_url(paste0("https://cepf-stp-threat-flora.netlify.app/img/leaflet_", 
                          gsub(" ", "_", taxa_name), ".html"))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

if (fixed_maps_outputs$map_for_ST) {
  
  base_plot_ST_spec <-
    climate_occ_maps_ST(layers_env_ST = layers_env_ST,
                        taxa = taxa_name,
                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)
  
}


if (fixed_maps_outputs$map_for_P) {
    
 base_plot_P_spec <- climate_occ_maps_P(layers_env_P = layers_env_P, 
                                        taxa = taxa_name, 
                                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)

}


```



```{r, eval=fixed_maps_outputs$map_for_ST, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of São Tomé.")}

base_plot_ST_spec

```

```{r, eval=fixed_maps_outputs$map_for_P, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of Príncipe.")}

base_plot_P_spec

```

```{r, eval=eval_diameter_plot, echo=FALSE, fig.cap=paste("Histogram of diameters of all stems identified as", taxa_name)}

combined_dataset %>% 
  filter(!is.na(id_n), tax_infra_level == taxa_name) %>% 
  dplyr::select(stem_diameter) %>% 
  ggplot() + 
  geom_histogram(mapping = aes(stem_diameter), binwidth = 1)


```


```{r, message=FALSE, echo=FALSE, warning=FALSE, results='hide'}

# figs_paths <- get_figs_paths(taxa = taxa_name)

all_files_fotos <- list.files("./images/", pattern = ".jpg")

all_files_fotos <- all_files_fotos[grepl(gsub(" ", "_", taxa_name), all_files_fotos)]

if (length(all_files_fotos) > 0) {
  
  show_foto <- TRUE
  
  copyrights <- unlist(lapply(strsplit(all_files_fotos, "_"), function(x) x[length(x)]))
  copyrights <- unlist(lapply(strsplit(copyrights, "[.]"), function(x) x[1]))
  
  caps <- paste("Copyright", copyrights)
  
} else {
  
  show_foto <- FALSE
  
}

```

```{r , eval=show_foto, echo=FALSE, fig.cap=caps, out.width = '70%'}
knitr::include_graphics(paste0("./images/", "/", all_files_fotos))
```






















#### ```r list_tax %>% slice(2) %>% pull(tax_infra_level_auth)```


```{r , echo=FALSE, message=FALSE, warning=FALSE}

taxa_name <- list_tax %>% slice(2) %>% pull(tax_infra_level)

id_sp <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(idtax_f)

iucn_status <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(iucn_status)

combined_dataset_sf <- 
  combined_dataset %>%
  filter(georef_final == 1, 
         idtax_f == id_sp) %>%
  st_as_sf(coords = c("ddlon", "ddlat"))

st_crs(combined_dataset_sf) <- 4326


transect_data <- combined_dataset %>% filter(!is.na(id_n), tax_infra_level == taxa_name) %>% dplyr::select(stem_diameter) 

if (nrow(transect_data) >= 20) {
  
  eval_diameter_plot <- TRUE
  
} else {
  
  eval_diameter_plot <- FALSE
  
}


```


```{r , echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}

fixed_maps_outputs <- generate_fixed_maps(id_sp = id_sp,
                    dataset = combined_dataset, 
                    dataset_sf = combined_dataset_sf,
                    STP_list = list(P = P, ST = ST), 
                    size.legend.txt = 7, 
                    size.pts = 5, 
                    protected_areas = protected_areas, 
                    export_tiff = FALSE)

if (nrow(combined_dataset_sf) > 0) {
  make_lf_map <- TRUE
} else {
  make_lf_map <- FALSE
}

```


```{r, message=FALSE, echo=FALSE, warning=FALSE, eval=make_lf_map}

selected_sf <- generate_sp_leaflet(taxa = taxa_name, 
                                   dataset = combined_dataset_sf)

```

#### Status {.unnumbered}

```{r, echo=FALSE, out.width="20%"}

if (!is.na(iucn_status))
  knitr::include_graphics(paste0("./images/", iucn_status, ".png"))

```

#### Rationale {.unnumbered}

*Begonia baccata* grows in open areas in rainforest (often secondary), usually on steep wet slopes, and it is found mostly below 1,500 m in elevation, rarely down to sea level. The species is endemic to São Tomé and is known from 78 collections made between 1861 (Mann 1087) and 2020 (Ikabanga 1031, Lima 23, Nguema 3318) in the north-center and south of the island. Two collections (Moller 146, Mann 1087) were not taken into account in this assessment since they are not precisely georeferenced. Seven occurrences  located around Bom Sucesso are considered as extirpated given the intensity of agricultural activities (vegetable plantations) present in this locality. The occurrence (Chevalier 14208) at Porto Alegre is extirpated. These ten collections were not considered for this evaluation. The 66 remaining collections represent 44 occurrences. The dispersal is assumed to be by birds (Plana 2002). We, therefore, consider these 49 occurrences as one subpopulation. Twenty-seven occurrences of them are located outside of PNOST. Based on a 2 x 2 km cell size, the AOO  of this species is estimated as 152 km2, and the EOO is calculated as 399 km2, both below the upper threshold for EN status under criterion B. Among the 17 occurrences within PNOST, seven occurrences of them (along the tourist path) and one (at the camp near Morro Vilela) are threatened by ecotourism activity and represent one location. The occurrence located at Bom Sucesso (within PNOST) is threatened by agricultural activities (vegetable plantations) and represents one location. The three occurrences at Monte Cabumbé are not threatened and represent one location. The occurrence located at Lembà and the four last occurrences in the south of part PNOST could be threatened by agriculture and represent one location. Therefore these 17 occurrences represent three locations. Among the 32 occurrences outside PNOST, four are located in the south of the island, two threatened by small-scale agricultural activities and two are not threatened; these four occurrences represent two locations, among which two will probably disappear. The ten occurrences located in the west of the island are threatened by urbanization at Santa Catarina, by small-scale agriculture (near limit west of PNOST) and by past and current large-scale agriculture (Binda region), so they represent three locations. The five occurrences located in the north (outside protected areas) were threatened by past large-scale agriculture (Chamiço region) and represent one location. The occurrence located around Bom Sucesso is threatened by agricultural activities (vegetable plantations) and represents one location. We infer that they will disappear in near future. The three last occurrences located at the southwestern of Macambrarà near PNOST are threatened by illegal logging. So, these three occurrences represent one location. Therefore, these 44 occurrences represent 17 locations (sensu IUCN, 2019), with regards to the most serious plausible threats (small-scale agriculture and urbanization). Despite the disappearance of seven occurrences in the south part of island, this species occurs mostly on wet slopes that are usually too steep for agriculture and is, therefore, able to survive even within quite degraded areas. The species is not severely fragmented and does not meet the threshold of any threatened categories under criterion B. We cannot apply criterion A because less than 10% and 8% of respectively EOO and AOO are expected to disappear (calculated by GeoCAT). *Begonia baccata*  is therefore assessed as LC.


#### Habitat and ecology {.unnumbered}

The species is known from open areas in rainforest (often secondary), usually on steep wet slopes, mostly between 800 and 1,500 m in elevation but sometimes down to sea level.



#### Use and trade {.unnumbered}
It is grown as an ornamental plant.

#### Population {.unnumbered}
Population information is not known for this species.


```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in São Tomé.")}

fixed_maps_outputs$map_ST

```

```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in Príncipe.")}

fixed_maps_outputs$map_P

```

```{r, eval=make_lf_map,  echo=FALSE, message=FALSE, warning=FALSE, fig.cap="An interactive distribution map."}

knitr::include_url(paste0("https://cepf-stp-threat-flora.netlify.app/img/leaflet_", 
                          gsub(" ", "_", taxa_name), ".html"))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

if (fixed_maps_outputs$map_for_ST) {
  
  base_plot_ST_spec <-
    climate_occ_maps_ST(layers_env_ST = layers_env_ST,
                        taxa = taxa_name,
                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)
  
}


if (fixed_maps_outputs$map_for_P) {
    
 base_plot_P_spec <- climate_occ_maps_P(layers_env_P = layers_env_P, 
                                        taxa = taxa_name, 
                                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)

}


```



```{r, eval=fixed_maps_outputs$map_for_ST, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of São Tomé.")}

base_plot_ST_spec

```

```{r, eval=fixed_maps_outputs$map_for_P, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of Príncipe.")}

base_plot_P_spec

```

```{r, eval=eval_diameter_plot, echo=FALSE, fig.cap=paste("Histogram of diameters of all stems identified as", taxa_name)}

combined_dataset %>% 
  filter(!is.na(id_n), tax_infra_level == taxa_name) %>% 
  dplyr::select(stem_diameter) %>% 
  ggplot() + 
  geom_histogram(mapping = aes(stem_diameter), binwidth = 1)


```


```{r, message=FALSE, echo=FALSE, warning=FALSE, results='hide'}

# figs_paths <- get_figs_paths(taxa = taxa_name)

all_files_fotos <- list.files("./images/", pattern = ".jpg")

all_files_fotos <- all_files_fotos[grepl(gsub(" ", "_", taxa_name), all_files_fotos)]

if (length(all_files_fotos) > 0) {
  
  show_foto <- TRUE
  
  copyrights <- unlist(lapply(strsplit(all_files_fotos, "_"), function(x) x[length(x)]))
  copyrights <- unlist(lapply(strsplit(copyrights, "[.]"), function(x) x[1]))
  
  caps <- paste("Copyright", copyrights)
  
} else {
  
  show_foto <- FALSE
  
}

```

```{r , eval=show_foto, echo=FALSE, fig.cap=caps, out.width = '70%'}
knitr::include_graphics(paste0("./images/", "/", all_files_fotos))
```





#### ```r list_tax %>% slice(3) %>% pull(tax_infra_level_auth)```


```{r , echo=FALSE, message=FALSE, warning=FALSE}

taxa_name <- list_tax %>% slice(3) %>% pull(tax_infra_level)

id_sp <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(idtax_f)

iucn_status <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(iucn_status)

combined_dataset_sf <- 
  combined_dataset %>%
  filter(georef_final == 1, 
         idtax_f == id_sp) %>%
  st_as_sf(coords = c("ddlon", "ddlat"))

st_crs(combined_dataset_sf) <- 4326


transect_data <- combined_dataset %>% filter(!is.na(id_n), tax_infra_level == taxa_name) %>% dplyr::select(stem_diameter) 

if (nrow(transect_data) >= 20) {
  
  eval_diameter_plot <- TRUE
  
} else {
  
  eval_diameter_plot <- FALSE
  
}


```


```{r , echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}

fixed_maps_outputs <- generate_fixed_maps(id_sp = id_sp,
                    dataset = combined_dataset, 
                    dataset_sf = combined_dataset_sf,
                    STP_list = list(P = P, ST = ST), 
                    size.legend.txt = 7, 
                    size.pts = 5, 
                    protected_areas = protected_areas, 
                    export_tiff = FALSE)

if (nrow(combined_dataset_sf) > 0) {
  make_lf_map <- TRUE
} else {
  make_lf_map <- FALSE
}

```


```{r, message=FALSE, echo=FALSE, warning=FALSE, eval=make_lf_map}

selected_sf <- generate_sp_leaflet(taxa = taxa_name, 
                                   dataset = combined_dataset_sf)

```

#### Status {.unnumbered}

```{r, echo=FALSE, out.width="20%"}

if (!is.na(iucn_status))
  knitr::include_graphics(paste0("./images/", iucn_status, ".png"))

```

#### Rationale {.unnumbered}

*Begonia crateris* is a shrub up to 4 m high. It has been suggested that it might be synonymous with *B. baccata* (Ferreira, 1965) but Reitsma (1985) and Plana (2002) considered it as a distinct species, a view supported by recent fieldwork. One collection (Chevalier 13748) was made around Boa Entrada (300 m in elevation). Based on lower elevation and degradation of habitat at Boa Entrada, we consider that this collection probably represents a cultivated subpopulation, and whether the occurrence still exists is not clear. So, this collection was excluded from this assessment. The 20 remaining collections represent 11 occurrences, none of which are considered as extirpated. Three occurrences are located in the area of Roça Calvàrio, outside of the PNOST. The seeds are dispersed by birds (Plana, 2002), so these 11 occurrences represent 1 or 2 subpopulations. Based on a 2 x 2 km cell size, the AOO of this species is estimated to be 24 km2, below the upper threshold for EN status under subcriterion B2. The EOO is calculated as 34.5 km2, below the upper threshold for CR status under subcriterion B1. The five occurrences along the tourist path are threatened by ecotourism, and represent one location. Two occurrences around Lagoa Amelia (within PNOST), and three others around Macambrará (outside of the protected area), are both threatened for traditional medicinal use, especially at Lagoa Amelia. Indeed, leaves of this species are used to make a tea to prevent abortion and local people often cut leafy stems from adult individuals. The three occurrences located around Macambará are also threatened by illegal forest logging that affects the species’ habitat. Despite occurring within and outside PNOST, the five occurrences (Macambará and Lagoa Amelia) are affected simultaneously by a given and represent one location. The occurrence of Monte Cabumbé is not threatened and represents one location. Consequently, these 11 occurrences represent three locations (sensu IUCN, 2019), with regard to the most important threat (traditional medicinal use) which induces a continuing decline in the number of mature individuals by cutting adult individuals. We also infer a past, current and future continuing decline in the extent and habitat quality. This species is thus assessed as EN B1ab(iii,v)+2ab(iii,v).


#### Habitat and ecology {.unnumbered}

The species occurs in submontane and montane rainforest, usually in half-open areas, between 800 and 2,020 m in elevation.



#### Use and trade {.unnumbered}
The leaves of the species are used to make a tea to prevent abortion.

#### Population {.unnumbered}
Population information is not precisely known for this species.


```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in São Tomé.")}

fixed_maps_outputs$map_ST

```

```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in Príncipe.")}

fixed_maps_outputs$map_P

```

```{r, eval=make_lf_map,  echo=FALSE, message=FALSE, warning=FALSE, fig.cap="An interactive distribution map."}

knitr::include_url(paste0("https://cepf-stp-threat-flora.netlify.app/img/leaflet_", 
                          gsub(" ", "_", taxa_name), ".html"))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

if (fixed_maps_outputs$map_for_ST) {
  
  base_plot_ST_spec <-
    climate_occ_maps_ST(layers_env_ST = layers_env_ST,
                        taxa = taxa_name,
                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)
  
}


if (fixed_maps_outputs$map_for_P) {
    
 base_plot_P_spec <- climate_occ_maps_P(layers_env_P = layers_env_P, 
                                        taxa = taxa_name, 
                                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)

}


```



```{r, eval=fixed_maps_outputs$map_for_ST, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of São Tomé.")}

base_plot_ST_spec

```

```{r, eval=fixed_maps_outputs$map_for_P, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of Príncipe.")}

base_plot_P_spec

```

```{r, eval=eval_diameter_plot, echo=FALSE, fig.cap=paste("Histogram of diameters of all stems identified as", taxa_name)}

combined_dataset %>% 
  filter(!is.na(id_n), tax_infra_level == taxa_name) %>% 
  dplyr::select(stem_diameter) %>% 
  ggplot() + 
  geom_histogram(mapping = aes(stem_diameter), binwidth = 1)


```


```{r, message=FALSE, echo=FALSE, warning=FALSE, results='hide'}

# figs_paths <- get_figs_paths(taxa = taxa_name)

all_files_fotos <- list.files("./images/", pattern = ".jpg")

all_files_fotos <- all_files_fotos[grepl(gsub(" ", "_", taxa_name), all_files_fotos)]

if (length(all_files_fotos) > 0) {
  
  show_foto <- TRUE
  
  copyrights <- unlist(lapply(strsplit(all_files_fotos, "_"), function(x) x[length(x)]))
  copyrights <- unlist(lapply(strsplit(copyrights, "[.]"), function(x) x[1]))
  
  caps <- paste("Copyright", copyrights)
  
} else {
  
  show_foto <- FALSE
  
}

```

```{r , eval=show_foto, echo=FALSE, fig.cap=caps, out.width = '70%'}
knitr::include_graphics(paste0("./images/", "/", all_files_fotos))
```








#### ```r list_tax %>% slice(4) %>% pull(tax_infra_level_auth)```


```{r , echo=FALSE, message=FALSE, warning=FALSE}

taxa_name <- list_tax %>% slice(4) %>% pull(tax_infra_level)

id_sp <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(idtax_f)

iucn_status <- endemic_list %>% 
  filter(tax_infra_level == taxa_name) %>% 
  pull(iucn_status)

combined_dataset_sf <- 
  combined_dataset %>%
  filter(georef_final == 1, 
         idtax_f == id_sp) %>%
  st_as_sf(coords = c("ddlon", "ddlat"))

st_crs(combined_dataset_sf) <- 4326


transect_data <- combined_dataset %>% filter(!is.na(id_n), tax_infra_level == taxa_name) %>% dplyr::select(stem_diameter) 

if (nrow(transect_data) >= 20) {
  
  eval_diameter_plot <- TRUE
  
} else {
  
  eval_diameter_plot <- FALSE
  
}


```


```{r , echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}

fixed_maps_outputs <- generate_fixed_maps(id_sp = id_sp,
                    dataset = combined_dataset, 
                    dataset_sf = combined_dataset_sf,
                    STP_list = list(P = P, ST = ST), 
                    size.legend.txt = 7, 
                    size.pts = 5, 
                    protected_areas = protected_areas, 
                    export_tiff = FALSE)

if (nrow(combined_dataset_sf) > 0) {
  make_lf_map <- TRUE
} else {
  make_lf_map <- FALSE
}

```


```{r, message=FALSE, echo=FALSE, warning=FALSE, eval=make_lf_map}

selected_sf <- generate_sp_leaflet(taxa = taxa_name, 
                                   dataset = combined_dataset_sf)

```

#### Status {.unnumbered}

```{r, echo=FALSE, out.width="20%"}

if (!is.na(iucn_status))
  knitr::include_graphics(paste0("./images/", iucn_status, ".png"))

```

#### Rationale {.unnumbered}

*Begonia fusialata* var. *príncipensis* is an herb up to 3 m long and is found on wet rocks in half shade; below 200 m in elevation. The taxon is endemic to Príncipe island, and is known from 9 collections made probably between 1857 (Barter 2037) and 1986 (de Wilde 8819). The first collection (Barter 2037) is not precisely located. One collection (Van Veldhuizen 1035) was made from Wageningen greenhouse (Netherlands) without clear locality of collection. Both collections (Barter 2037; Van Veldhuizen 1035) have been excluded from estimated parameters. Four collections (Rose 443; 464; 474; 475) were made in 1956 from Porto Real in the northern center part of Príncipe. Three collections were made from the south part of the island, two of them (de Wilde 399; 8819) from Pico Mesa and the last collection (Rozeira 2566) was made from Caminho de Macoia. Considering the rock coverage, which is still important in places of other collections, we consider that none of all occurrences are extirpated. These seven specimens represent three occurrences. The dispersal ability is conferred by bird vectors (Plana, 2002), so these three occurrences represent one subpopulation. Based on a 2 x 2 km grid cell size, the AOO and the EOO of this species are respectively estimated as 8 km2 and 5.3 km², both below the upper threshold for CR status under Criterion B. The estimated EOO is lower than the AOO, we thus consider EOO equal to AOO (8 km2), which is below the upper threshold for CR status under Criterion B1. The occurrence from Porto Real is threatened by stone quarries, house constructions and cacao agriculture. This occurrence represents one location. Two occurrences are located within the protected area, the PNOP, but the occurrence located at Pico Mesa was threatened by old plantation for subsistence and represents one location. The occurrence of Caminho de Macoia is not clearly threatened and represents one location. We infer that the presence of stone quarries induces a decline in the number of mature individuals. All of the three occurrences represent three locations (sensu IUCN, 2019) with the most important threat (stone quarries). Based on the past, current and future threats to these occurrences, we inferred a decline in the quality of its habitat. We could infer a future continuing decline in the extent and habitat quality, and the number of mature individuals. This sub-species is thus assessed as EN B1ab(iii,v)+2ab(iii,v).



#### Habitat and ecology {.unnumbered}

The species is found on wet rocks in half shade; below 200 m in elevation.


#### Use and trade {.unnumbered}
There are no known uses of this species.

#### Population {.unnumbered}
Population information is not precisely known for this species.


```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in São Tomé.")}

fixed_maps_outputs$map_ST

```

```{r, eval=F, echo=FALSE, fig.cap=paste("Distribution of", taxa_name, "in Príncipe.")}

fixed_maps_outputs$map_P

```

```{r, eval=make_lf_map,  echo=FALSE, message=FALSE, warning=FALSE, fig.cap="An interactive distribution map."}

knitr::include_url(paste0("https://cepf-stp-threat-flora.netlify.app/img/leaflet_", 
                          gsub(" ", "_", taxa_name), ".html"))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

if (fixed_maps_outputs$map_for_ST) {
  
  base_plot_ST_spec <-
    climate_occ_maps_ST(layers_env_ST = layers_env_ST,
                        taxa = taxa_name,
                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)
  
}


if (fixed_maps_outputs$map_for_P) {
    
 base_plot_P_spec <- climate_occ_maps_P(layers_env_P = layers_env_P, 
                                        taxa = taxa_name, 
                                        dataset = combined_dataset_sf, 
                                        shape.pts = 4)

}


```



```{r, eval=fixed_maps_outputs$map_for_ST, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of São Tomé.")}

base_plot_ST_spec

```

```{r, eval=fixed_maps_outputs$map_for_P, warning=FALSE, echo=FALSE, fig.cap=paste("Occurrences of", taxa_name, "in the climate conditions of Príncipe.")}

base_plot_P_spec

```

```{r, eval=eval_diameter_plot, echo=FALSE, fig.cap=paste("Histogram of diameters of all stems identified as", taxa_name)}

combined_dataset %>% 
  filter(!is.na(id_n), tax_infra_level == taxa_name) %>% 
  dplyr::select(stem_diameter) %>% 
  ggplot() + 
  geom_histogram(mapping = aes(stem_diameter), binwidth = 1)


```


```{r, message=FALSE, echo=FALSE, warning=FALSE, results='hide'}

# figs_paths <- get_figs_paths(taxa = taxa_name)

all_files_fotos <- list.files("./images/", pattern = ".jpg")

all_files_fotos <- all_files_fotos[grepl(gsub(" ", "_", taxa_name), all_files_fotos)]

if (length(all_files_fotos) > 0) {
  
  show_foto <- TRUE
  
  copyrights <- unlist(lapply(strsplit(all_files_fotos, "_"), function(x) x[length(x)]))
  copyrights <- unlist(lapply(strsplit(copyrights, "[.]"), function(x) x[1]))
  
  caps <- paste("Copyright", copyrights)
  
} else {
  
  show_foto <- FALSE
  
}

```

```{r , eval=show_foto, echo=FALSE, fig.cap=caps, out.width = '70%'}
knitr::include_graphics(paste0("./images/", "/", all_files_fotos))
```













